# 4、`IP`协议

## 4.1、`IP`基础知识

**<font size =4 color = red>`IP`</font>**

> `IP`相当于`OSI`模型中的`网络层`，`网络层`要实现终端节点之间的通信，点对点通信。

`数据链路层`主要在互连的同一种`数据链路`的节点之间进行的包传递，跨越多种就需要`网络层`。

`IP`大致有3个作用模块

- `IP`寻址
- 路由
- `IP`分包和组包


> 主机：配置有`IP`地址，但不进行路由控制的设备
>
> 
> 路由器：配置有`IP`地址，同时进行路由控制的设备

**<font size =4 color = red>路由控制</font>**

> 路由控制：指将分组数据发送到最终目的地址的功能。

> `跳`：网络中的一个区间，主机或者路由器网卡不经其他路由器或者网关能直接到达相邻主机或者路由器网卡的范围。

`IP路由`叫做`多跳路由`，每个路由器指定下一跳。`数据链路层`实现一跳内的通信。

`路由控制表`：记录`IP`地址下一步发给哪个路由器。

**<font size =4 color = red>数据链路的抽象化</font>**

`IP`对`数据链路`进行抽象化。不同`数据链路`的最大区别是`MTU`不同，`IP`在传输的时候，需要传`MTU`，`IP`进行分片处理，分成多个较小的`IP`包，抽象了`数据链路`。

`IP`属于面向无连接型，无需建立与对端目标地址之间的连接，目的有两个，一个是简化，一个是提速。为了提高通信的可靠性，上一层的`TCP`采用面向有连接型。

## 4.2、`IP`地址基础知识

**<font size =4 color = red>`IP`地址</font>**

> `IP`地址是32位整数，在计算机内以二进制方式被处理。

将`IP`地址以每8位1组，共4组，2的32次方约为43亿，理论上最大允许43亿台计算机进行联网。

`IP`地址配置
- 1台主机的每块网卡都要设置`IP`地址，可以配置1个以上的`IP`地址；
- 1块网卡可以配置两个以上的`IP`地址，但是一般只配置1个`IP`地址
- 1台路由器可以配置两个以上的`IP`地址，。

`IP`地址的组成
- 网络地址：在数据链路的每个段配置不同的值，相同段内相连的主机必须有相同的网络地址。路由器根据IP地址的网络地址进行转发，判断是否为该网段内的主机
- 主机地址：不允许在同一个网段内重复出现。

现在区分网络标识和主机标识，使用`子网掩码`进行区分

|IP地址分类|说明|
|-|-|
|`A类地址`|`0.0.0.0-127.0.0.0`<li>`A类地址`第1个字节为网络号，但是首位为0，可以指派的网络号为126个，`A类地址`的后24位是主机号；<li>网络号全是0（0000 0000）的`IP`地址是保留地址，意思是`本网络`<li>网络号是127（0111 1111）的IP地址也是保留地址，作为本地环回软件测试；<li>主机号全是0的IP地址表示是“本主机”所连接到的单个网络；<li>主机号全是1的IP地址表示是该网络上的所有主机。|
|`B类地址`|`128.0.0.0-191.255.0.0`，<li>B类地址第1、2位固定为1、0，网络号有14位可以使用，128.0的网络号不指派，可用网络号需要减1，B类的后16位是主机；<li>主机号全是0的`IP`地址表示是“本主机”所连接到的单个网络；<li>主机号全是1的`IP`地址表示是该网络上的所有主机。|
|`C类地址`|`192.0.0.0-233.255.255.0`，<li>第1-24位为网络标识,192.0.0保留不指派，可用网络号需要减1；<li>主机号全是0的`IP`地址表示是“本主机”所连接到的单个网络；<li>主机号全是1的IP地址表示是该网络上的所有主机。|
|`D类地址`|`224.0.0.0-239.255.255.255`，<li>第1-32位为网络标识，`D类地址`第1个字节以1110开始。<li>它是一个专门保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播中。多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。|
|`E类地址`|以11110开始，为将来使用保留。|


![A-C类 IP地址](https://img-blog.csdn.net/20160312204806217)

**<font size =4 color = red>广播地址</font>**

> 广播地址：用于在同一个链路中相互连接的主机发送数据包，将`IP`地址的主机地址部分设置成1，就成了广播地址。

|广播分类|说明|
|-|-|
|本地广播|在本网络内广播叫做本地广播，如192.168.0.0/24的广播地址为192.168.0.255/24,因为这个广播地址的`IP`包会被路由器屏蔽，不会到达192.168.0.0/24以外的地方。|
|直接广播|在不同网络之间的广播叫做直接广播，如192.168.0.0/24向192.168.1.255/24的目标地址发送`IP`包，收到这个包的路由器，将数据转发给192.168.1.0/24，从而192.168.1.1/24-192.168.1.254/24的主机都会收到这个包。|


**<font size =4 color = red>`IP`多播</font>**

> 多播：用于将包发送给特定组内的所有主机。

广播无法穿透路由器，且不接受广播的主机会判断是否有必要接收数据，否则丢弃。使用多播可以穿透路由。

多播使用`D类地址`，`D类地址`前4位为1110，从224.0.0.0-239.255.255.255都是多播地址的可用范围。其中从224.0.0.0-224.0.0.255的范围不需要路由控制。在多播中，所有主机必须数据224.0.0.1的组，所有的路由必须属于224.0.0.2的组，多播地址中还有其他有代表性的地址。

**<font size =4 color = red>子网掩码</font>**

`IP`地址分类会造成浪费，如理论上`B类地址`的一个链路最多允许65534台主机连接，但是实际上不会有这么多计算机连接，造成了浪费。

`子网掩码`通过`子网`网络细分出比`A类`、`B类`、`C类`地址更小粒度的网络。


> `子网掩码`：32位数字，对应`IP`地址网络标识部分全部为`1`，对应`IP`地址主机部分全部为`0`。可以自由定位网络标识的长度。

`子网掩码`的表示方式

1. 直接写出子网掩码的十进制表示，如`255.255.255.192`
2. 使用`/`隔开，如`172.20.100.52/26`表示前26位为网络地址，如果后面为0则可以简化，如`172.20.0.0/26`与`172.0/26`含义相同。


`子网掩码`实际就是将原来的`A类`，`B类`，`C类`地址的主机地址的部分位用作子网地址，可以将原来的网络划分成为多个物理网络的一种机制。

- `A类地址`的默认子网掩码：`255.0.0.0`
- `B类地址`的默认子网掩码：`255.255.0.0`
- `C类地址`的默认子网掩码：`255.255.255.0`

**<font size =4 color = red>`CIDR`和`VLSM`</font>**

> `CIDR子网掩码`：采用任意长度分割`IP`地址的网络标识和主机标识。

采用这种方法可以将连续多个`C类地址`划分到较大的网络中，通过路由集中降低了路由器的负担。

> `VLSM`：可变子网掩码

以上两种技术都是为了缓解全局`IP`地址不够用的情况，充分利用且不浪费`IP`地址，精简路由器中的路由表。


**<font size =4 color = red>私有地址和全局地址</font>**

即使采用了`子网掩码`，更加的细分网络，使得网络中分利用`IP`地址，也同样还有耗尽的风险。私有地址和全局地址就是为了缓解该风险的技术。

|私有地址|范围|
|-|-|
|`A类地址`|`10.0.0.0-10.255.255.255` （10/8）|
|`B类地址`|`172.16.0.0-172.31.255.255` （172.16/12）|
|`C类地址`|`192.168.0.0-192.168.255.255` （192.168/16）|

私有地址只需要保证在这个网络内地址唯一，在不同的域中出现相同的私有`IP`不会影响使用，可以不用考虑互联网即可配置相应的`IP`地址。除了上述私有地址外，其余的全部都是全局IP。

配有私有地址的主机联网时，需要通过`NAT`进行通信。

`IPv6`还未普及且`IPv4`即将耗尽，私有`IP`地址和`NAT`技术是解决`IP`分配问题的主流方案。

`全局IP`在世界范围和国家范围内都会由组织进行管理，用户在接入互联网时，由`ISP`向组织进行申请。

## 4.3、路由控制

> `路由控制表`：记录着网络地址和下一步应该发送至路由器的地址，由路由协议制作而成。

`路由控制表`的形成方式：
- 一种是管理员手动设置(`静态路由`控制)；
- 另外一种是路由器与其他路由器相互交换信息时自动刷新(`动态路由`控制)。

`IP`协议始终认为路由表是正确的。


`路由控制表`工作过程：
- 在发送`IP`包时，首先要确定`IP`包首部中的目标地址；
- 再从主机的`路由控制表`中找到与该地址具有相同网络地址的记录，根据该记录将`IP`包转发给相应的下一个路由器；

需要注意以下两点：
- 当`路由控制表`中不存在与待转发的目标地址相匹配的网络地址，则会将该包转发到默认路由；
- 如果`路由控制表`中存在多条相同的网络地址的记录，就选择一个相同位数最多的网络地址。

**如果路由表中下一个路由器的位置记录着某个主机或路由器网卡的IP地址，那就意味着发送的目标地址属于同一个链路**

|三类特殊路由|说明|
|-|-|
|`默认路由`|`默认路由`指路由表中任何一个地址都能与之匹配的记录<li>默认路由一般标记为`0.0.0.0/0`或者`default`|
|`主机路由`|`IP地址/32`被称为主机路由，意味着要基于主机上网卡配置的IP地址本身，而不是基于该地址的网络标识部分进行路由|
|`环回地址`|同一台计算机上的程序之间进行网络通信时所使用的默认地址<li>计算机使用一个特殊的`127.0.0.1`作为`环回地址`，具有一个叫做`localhost`的主机名，使用这个`IP`时，数据包将不会流向网络|

`路由控制表`可以通过聚合的方式来提高网络的性能。


## 4.4、`IP`分割处理与再构成处理

**<font size =4 color = red>数据链路不同，`MTU`则不同</font>**

不同的数据链路有着不同的`MTU`，不同的数据链路，每一帧的大小也不一样。`IP`抽象化了底层的数据链路。


**<font size =4 color = red>`IP`报文分片和重组</font>**

`IP`报文的分片由路由器进行，重组由目标主机进行重组。

`IP`首部中的`片偏移`字段表示分片之后每个分片在用户数据中的相对位置和该分片之后是否还有其他的分片。根据这个字段还可以判断一个`IP`数据报是否分片，以及当前分片为整个数据报的起始，中段还是末尾。


**<font size =4 color = red>`路径MTU发现`</font>**

> 传统分片处理的不足：路由器进行分片处理会增加网络负荷，其次在路由器分片处理的过程中，如果丢失了某一个分片，整个`IP`数据报就会作废。

`路径MTU`中无需分片时最大的`MTU`的大小，而是整个路径存在所有数据链路中最小的`MTU`，由发送主机进行分片处理，而不是由路由器分片处理，减轻路由器的负担，也可以在`TCP`中发送更大的包。

`路径MTU发现`的工作原理：
1. 首先在发送主机中将待发送的`IP`数据包首部分片禁止标志位设置为1，这样路由器就不会进行分片处理，而是将包丢弃，第一次发送的包被丢弃。
2. 随后路由器将一个`ICMP`的不可达消息将数据链路上的`MTU`发送给发送主机。然后发送主机根据这个`MTU`值进行分片，如此反复，直到数据报被发送至目标主机为止，没有再收到任何`ICMP`，就认为最后一次`ICMP`所通知的`MTU`为一个合适的`MTU`。
3. 当`MTU`的值比较多时，最少可以缓存10min，在这10min中使用刚刚求得的`MTU`，但是过了10min之后，则重新根据链路上的`MTU`做一次路径发现。


`UDP`采用`路径MTU发现`会在`IP`层进行分片，而`TCP`采用`路径MTU发现`，`IP`层不会被分片。


## 4.5、IPv4首部

![](https://images2018.cnblogs.com/blog/1090410/201805/1090410-20180525163922305-594383575.png (IPv4首部图))

- `版本`：4bit，表示标识`IP`首部的版本号。`IPv4`的版本号为4，`IPv6`的版本号为6.
- `首部长度`：4bit，表明`IP`首部的大小，单位为4字节，对于没有可选项的`IP`包，首部长度设置成为5，即20字节.
- `区分服务`：8bit，用来表明服务质量，每一位都有具体含义，但是目前的网络均忽视这些字段。
- `总长度`：16bit，`IP`首部和数据部分合起来的总字节数，`IP`包的最大长度为65535字节。
- `标识`：16bit，用于分片重组，同一个分片的标识值相同，不同分片的标识值不同。通常每发送一个`IP`包，它的值会递增。
- `标志`：3bit，表示包被分片的相关信息。bit0未使用，为0，bit1指示是否进行分片
  - 0-可以分片
  - 1-不能分片
  
  bit2指示包在被分片的情况下，是否为最后一个包
  - 0-最后一个分片包
  - 1-分片中的包
- `片偏移`：13bit，用来标识被分片的每一个分段相对于原始数据的位置，第一个分片对应的值为0。13位最多可以表示8192个相对位置。其单位为8字节，最大可以表示原始数据8*8192=65535个字节。
- `生存时间`：8bit，指可以中转多少个路由器的意思。每经过一个路由器，`TTL`会减1，直到变成0则丢弃该包。
- `协议`：8bit，`IP`包传输层的上层协议编号。
- `首部校验和`：16bit，校验数据报的首部，不校验数据部分。用来确保`IP`数据报不被破坏。
- `源地址`：由32bit构成，发送端地址。
- `目的地址`：由32bit构成，目的地址。
- `可选项`：长度可变。
- `填充`：在有可选项的时候，首部长度可能不为32的整数倍，所以这个字段用来填0，调整为32的整数倍。
- `数据`：IP上层协议的首部也当做数据。

## 4.6、`IPv6`和`IPv6`首部

**<font size =4 color = red>`IPv6`介绍</font>**

`IPv6`有128bit，写成8个16位字节。为了根本解决IPv4地址耗尽的问题而标准化的协议。

`IPv6`的优点：
- `IP`地址的扩大与路由控制表的聚合
- 性能提升
- 支持即插即用功能 
- 采用认证与加密功能
- 多播，`MobileIP`成为拓展功能

`IPv6`地址的记法:
每16bit为一组，用`:`隔开，如果出现连续0的时候还可以将这些0省略，用两个冒号`::`隔开。但是同一个`IP`地址中只允许出现一次两个连续的冒号。每个冒号之间使用十六进制。


**<font size =4 color = red>`IPv6`地址结构</font>**

|`IPv6`地址结构||
|-|-|
|全局单播地址|世界上唯一的一个地址，不需要正式分配`IP`地址。是互联网通信中最为常见的一个`IPv6`地址。|
|链路本地单播地址|同一个数据链路内唯一的地址，由于不经过路由器，在接口ID中会保存64bit|
|唯一本地地址|不进行互联网通信时所使用的地址，设备控制的限制型网络，如公司，金融机关这些网络会与互联网隔离，通过`NAT`或者网关与互联网进行通信,唯一本地地址就是在这种情况下使用的。|

**<font size =4 color = red>`IPv6`分段处理</font>**

`IPv6`也支持`路径MTU发现`功能，`IPv6`中最小的`MTU`为1280字节。

**<font size =4 color = red>`IPv6`首部</font>**

![](https://images2018.cnblogs.com/blog/1090410/201805/1090410-20180525182659339-30491458.png (IPv6首部))

为了减轻路由器的负担，`IPv6`省略了首部校验和字段，提高了转发包的效率。

- `版本`：4bit版本号
- `通信量类`：相当于`IPv4`的区分服务字段，8bit
- `流标号`：20bit，准备用于服务质量控制。
- `有效载荷长度`：包的数据部分长度，与`IPv4`的`TL`不同，不包括首部，只表示数据部分的长度。由于`IPv6`的可选项是指连接`IPv6`首部的数据，因此当有可选项的时候，包含可选项数据的所有长度就是`PL`
- `下一个首部`：相当于`IPv4`中的协议字段，8bit构成，通常表示`IP`的上一层协议是`TCP`或者`UDP`。在有`IPv6`扩展首部的情况下，该字段表示后面第一个扩展首部的协议类型。
- `跳数限制`：8bit构成，与`IPv4`中的`TTL`相同
- `源地址`：128bit，发送端`IP`
- `目标地址`：128bit，接收端`IP`

`IPv6的扩展首部`通常介于`IPv6首部`和`TCP/UDP首部`中间，长度可以为任意长度。扩展首部可以包含扩展首部协议以及下一个扩展首部字段。`IPv6首部`没有标识及标志字段，在需要对`IP`数据报进行分片的时候，可以使用扩展首部。


# 5、`IP`协议相关技术

仅凭`IP`是无法完成通信的，必须还有能够解析主机名称和`MAC`地址的功能，以及数据包在发送过程中异常情况处理的功能。

## 5.1、`DNS`

**<font size =4 color = red>`DNS`的产生</font>**

早期：由于`IP`地址不便记忆，会给每个主机一个`主机识别码`为每个主机赋一个唯一的主机名，通信时直接使用主机名。系统必须自动将主机名转化成为具体的`IP`地址，会用到`hosts`数据库文件，这个数据库文件由特定机构管理，会定期更新，但是随着网络规模增大，这种集中管理主机名和`IP`地址的登录和更新的处理可行性降低。

在此背景下，产生了`DNS`系统，`DNS`系统是管理主机名和`IP`地址之前对应关系的系统。它可以维护一个用来表示组织内部主机名和`IP`地址之间对应关系的数据库，不管网络变得多么庞大，都能在一个较小的范围内通过`DNS`进行管理。


`DNS`协议是应用层协议。


**<font size =4 color = red>域名和域名服务器</font>**

> 域名：为了识别主机名称和组织机构名称的一种具有分层的名称，由几个英文字符用点号连接构成。


> 域名服务器：管理域名的主机或者相应的软件，可以管理所在分层的域的相关信息。

- `DNS`的分层结构像倒挂的树形结构，顶点是根，对应根域名服务器，下面每一层对应着不同的域名服务器；
- 各层域名服务器都了解该层以下分层的所有域名服务器的`IP`，当修改下层的域名或者重新设置域名服务器`IP`时，就需要在上层域名服务器中进行追加或修改；
- 所有域名服务器都注册根域名服务器的`IP`地址，因为DNS根据IP地址进行检索时，需要从根域名开始按照顺序进行；
- 域名服务器一般有两个或者三个，防止某个域名服务器出现宕机。


> 域名解析器：进行`DNS`查询的主机和软件叫做`DNS解析器`。用户使用的工作站或者个人电脑都属于解析器。

一个解析器至少要注册一个以上域名服务器的`IP`地址。通常，它至少包括组织内部的域名服务器的`IP`地址。

**<font size =4 color = red>`DNS`查询</font>**

查询流程：
1. 解析器为了查询`IP`地址，向域名服务器进行查询处理;
2. 接收这个查询请求的域名服务器首先会在自己的数据库上查找，如果有就返回，如果没有就再向上一层根域名服务器进行查询;
3. 重复上面的步骤，直到找到指定的域名服务器，并由这个域名服务器返回想要的数据；
4. 解析器和域名服务器可以将最新了解到的信息暂时保存在缓存里，减少查询时的性能消耗。

**<font size =4 color = red>`DNS`如同互联网内的分布式数据库</font>**

`DNS`除了管理主机名和`IP`地址的映射关系，还管理其他众多信息，如从`IP`地址检索主机名称，邮件地址和邮件接收服务器的主机名。

## 5.2、`ARP`

**<font size =4 color = red>`ARP`简介</font>**

确定了`IP`地址，就可以向目标地址发送`IP`数据报，而在底层数据链路层，进行实际`IP`通信时需要了解每个`IP`地址对应的`MAC地址`

`ARP`是一种解决地址问题的协议，用来定位下一个应该接收数据分包的网络设备对应的`MAC地址`。如果目标主机不在同一个链路中，可以通过`ARP`查找下一跳路由器的`MAC地址`。但该协议只适用于`IPv4`，不能用于`IPv6`，在`IPv6`中可以使用`ICMPv6`替代`ARP`发送邻居探索消息。       


**<font size =4 color = red>`ARP`的工作机制</font>**

> `ARP`通过`ARP`请求和`ARP`响应两种类型来确认`MAC地址`

主机A获取主机B的`MAC地址`具体工作原理：
- 主机A通过广播发送一个`ARP`请求包，包含想要了解的`MAC地址`的`IP地址`，即包含了主机B的`IP地址`；
- 这个`ARP`请求包会被链路上所有的主机或者路由器接收，被同一链路的所有主机和路由器解析；
- 如果某个主机收到了`ARP`请求包之后，发现目标`IP`和自己的`IP`一致就会将自己的`MAC`塞入`ARP`响应包返回给主机A。


因为`ARP`可以动态进行地址解析，因此无需事先知道`MAC地址`究竟是什么，只需要`IP地址`即可。

`ARP`减少网络流量的方法：

1. `ARP`请求之后会把获取到的`MAC地址`缓存一段时间，即将`IP地址`和`MAC地址`的映射关系放入`ARP缓存表`中，再次向这个`IP地址`发送数据报时就无需再重新发送`ARP`请求。可以减少`ARP`包在网络中大量被广播的可能性。减少不必要的网络流量。

2. 接收到`ARP请求包`的主机会获取发送端主机的`IP地址`和`MAC地址`，也会将发送主机的`MAC地址`给缓存起来，从而根据这个`MAC地址`发送`ARP响应包`给发送端主机，接收到`IP`数据报的主机又会继续返回`IP`数据报给发送端主机。


**<font size =4 color = red>`IP`和`MAC`缺一不可</font>**

- `MAC地址`不可缺：主机A发送`IP数据报`给其他数据链路的主机B，由于必须经过路由器C，主机A必须先将数据报发送给路由器C的`MAC地址`，如果`MAC地址`就使用广播地址，那么网络中的其他路由器D也会收到该广播，路由器D会将消息转发给路由器C，导致数据报被重发。`下一个路由器`就是相应的`MAC地址`。
- `IP地址`不可缺：如果仅使用`MAC地址`，那么网桥在习得之前就会向全世界发包，并维护一张巨大的表格维护习得的`MAC地址`。


**<font size =4 color = red>`RARP`和`代理ARP`</font>**

> `RARP`协议就是将`ARP`反过来，从`MAC地址`定位`IP地址`的一种协议，例如将打印机服务器等小型嵌入式设备接入到网络时会用到。

我们的个人`PC`可以自己设置`IP`，也可以通过`DHCP`自动分配`IP地址`，对于某些嵌入式设备，没有输入接口，就无法通过`DHCP`动态获取`IP地址`，这时就可以使用`RARP`。

`RARP`的原理：
- 使用`RARP`时，需要假设一台`RARP服务器`，在这个服务器上注册设备的`MAC地址`和`IP地址`。
- 在设备接入到网络中，设备会根据自己`MAC地址`向`RARP服务器`请求自己的`IP地址`
- `RARP服务器`返回`IP地址`给设备，设备获取`IP地址`。 

普通`ARP`会被路由器隔离，但是采用`代理ARP`的路由器可以将`ARP请求`转发给邻近的网段。

一般情况下路由器连接过个网络时，会在每个网段下定义自己的子网，进行路由控制。对于不支持设定子网掩码的老的设备来说，不使用`代理ARP`，有时就无法更好的使用网络。


## 5.3、`ICMP`

**<font size =4 color = red>`ICMP`介绍</font>**

> `ICMP`的主要功能：确认`IP包`是否成功送达目标地址，通知在发送过程中`IP包`被废弃的原因，改善网络设置等。

`ICMP`的工作原理：
- 主机A向主机B发送包，经过某一个路由器时发送`ARP包`，但是主机B电源关了；
- 路由器多次请求后始终无法获得主机B发送的`ARP响应包`，就会由该路由器返回一个`ICMP包`给主机A，说明发送给B的包没有成功。
- 主机A在接收到`ICMP包`之后，分解首部和数据部分分析具体发生的原因。
- `ICMP包`会使用`IP`进行发送。

**<font size =4 color = red>`ICMP`消息类型</font>**
|`ICMP`消息类型|说明|
|-|-|
|`ICMP目标不可达消息`（类型3）|路由器无法将`IP数据报`发送给目的地址时，会给发送端主机返回一个`目标不可达ICMP消息`，并在这个消息中显示不可到达的具体原因。<li>错误代码1，表示路由表中无主机信息，或者该主机没有连接到网络等意思；<li>错误代码4，表示`路径MTU发现`中路由器返回的`ICMP消息`|
|`ICMP原点抑制消息`（类型4）|当网络拥堵的时候，路由器就会向原地址发送一个源点抑制消息，发送端知道出现网络拥堵，打开IP传输间隔。这个会引起不公平的通信网络，一般不使用。|
|`ICMP重定向消息`（类型5）|若路由器发现发送端主机使用的不是最优的路径发送数据，会返回一个`ICMP重定向消息`给发送主机，包含最优的路由信息和源数据。但是多数情况下这种重定向会成为引发问题的原因，往往不设置。|
|`ICMP路由器探索消息`（类型9、10）|用于发现与自己相连的路由器。<li>主机发出`ICMP路由器请求`（类型10），路由器则返回`ICMP路由器公告消息`（类型9）<li>`traceroute`命令可以显示出由执行程序的主机到达目标主机前经历了多少路由器|
|`ICMP超时消息`（类型11）|`IP包`中`TTL`每经过一次路由器就会减1，直到0时被丢弃，此时路由器就会发送`ICMP超时消息`告诉发送端主机，该包已经被丢弃。设置`TTL`是为了防止发生路由错误时出现循环，导致`IP包`被循环发送。|
|`ICMP回送消息`（类型0、8）|判断发送的数据包是否成功到达对端的消息。<li>向对端主机发送`ICMP回送请求`的消息（类型8），接受对端主机发回来的`ICMP回送应答消息`（类型0）。<li>网络上的ping命令就是利用这个消息实现的。|
|`ICMP地址掩码消息`（类型17、18）|主机或路由器想要了解子网掩码的情况<li>主机向目标主机或者路由器发送`ICMP地址掩码请求消息`（类型17），通过接收`ICMP地址掩码应答消息`（类型18）获取子网掩码的信息。|

**<font size =4 color = red>`ICMPv6`</font>**

`ICMP`在`IPv4`中是辅助作用，缺少了也可以进行通信，但是在IPv6中缺少了ICMPv6就会无法通信。

`ARP`在`IPv6`中转变成为`ICMP邻居探索消息`，该消息融合了`IPv4`的`ARP`、`ICMP重定向消息`等消息功能于一体。

`ICMPv6`的0-127为错误消息，128-255为信息消息。其中133-137为`邻居探索消息`，`邻居请求消息`用于查询`IPv6地址`和`MAC地址`对应关系，利用`IPv6`的多播地址实现传输。


## 5.4、`DHCP`

**<font size =4 color = red>`DHCP`协议作用</font>**

> `DHCP协议`：为了实现自动设置`IP地址`，统一管理`IP地址`分配。有了`DHCP`，计算机只要连接到网络，就可以进行`TCP/IP`通信，`即插即用`。

在没有`DHCP`服务的网络中，用户接入网络需要先设置`IP地址`和子网掩码，由管理员确保所有主机`IP地址`唯一，避免冲突。而在接入`DHCP`服务的网络，只要接入到网络中就可以自动获取关于`TCP/IP`相关的设置，管理员仅需要做一些设置即可。

`DHCP协议`不仅可以在`IPv4`中，在`IPv6`中也可以使用。

**<font size =4 color = red>`DHCP`工作机制</font>**

使用`DHCP`之前需要架设`DHCP服务器`，将所需要分配的IP地址，相应的子网掩码，路由控制信息以及`DNS服务器`的地址设置到服务器上。很多时候使用该网段的路由器充当`DHCP服务器`。

`DHCP`工作过程:
1. `DHCP客户端`发送`DHCP发现包`，要求设置`IP地址`和子网掩码;
2. `DHCP服务器`通知可以使用的网络设置，发送`DHCP提供包`；
3. `DHCP客户端`发送`DHCP通知包`，通知想要使用在`DHCP提供包`中的设置；
4. `DHCP服务端`发送`DHCP提供包`，允许客户端进行设置；
5. 在不需要`IP地址`时，可以发送`DHCP解除包`；
6. `DHCP`的设置中通常都会有一个限制时间的设定，`DHCP客户端`在这个时限之前可以发送`DHCP请求包`通知想要延长时限。
7. `DHCP服务器`如果发生故障，会导致无法自动分配`IP地址`，导致整个网段内所有的主机无法进行`TCP/IP`通信，为此，通常会架设两台或者以上的DHCP服务器。

为了检查所要分配的`IP地址`以及已经分配了的`IP地址`是否可用，`DHCP服务器`或者`DHCP客户端`必须具备以下功能
- `DHCP服务器`：在分配`IP地址`前发送`ICMP回送请求包`，确认没有返回应答，就是ping不通
- `DHCP客户端`：针对从`DHCP服务器`那里的`IP地址`发送`ARP请求包`，确认没有返回应答。

**<font size =4 color = red>`DHCP`中继代理</font>**

家庭中大多都只有一个以太网的网段，与其连接的主机不会太多，只要一台`DHCP服务器`就可以满足`IP`分配，由家里的宽带路由器充当这个角色。

而在企业或者学校这种地方，会有多个以太网段，若每个网段的路由器担任`DHCP服务器`的角色，后续维护也会变得困难。具体可以使用`DHCP中继代理`实现，只需要在每个网段设置一个`DHCP中继代理`即可，它可以设置`DHCP服务器`的`IP地址`。从而可以在`DHCP服务器`上为每个网段注册`IP地址`的分配范围。

`DHCP中继代理`多为路由器，不过也有在主机中安装某些软件实现的情况。

`DHCP中继代理`的工作流程：
- `DHCP客户端`向`DHCP中继代理`发送请求包；
- `DHCP中继代理`在接收到了这个广播报之后，再以单播的形式发送给`DHCP服务器`；
- `DHCP服务器`向`DHCP中继代理`返回应答，再由`DHCP中继代理`转发包给`DHCP`客户端。



## 5.5、`NAT(NAPT)`

**<font size =4 color = red>`NAT`简介</font>**

> `NAT`：用于在本地网络中使用`私有地址`，在连接互联网时转而使用`全局IP地址`的技术。是为了面临枯竭的`IPv4`开发的技术。

**<font size =4 color = red>`NAT`的工作机制</font>**

`NAT`的工作原理：
1. 局域网内设置为`私有IP地址`，在与外部通信时，`IP包`经过`NAT路由器`，转换`IP首部`的源地址，将其转换成`全局IP`再转发给互联网中的`全局目标IP地址`；
2. 互联网中的`全局IP包`发送给局域网中的主机时，`IP包`中的`目标全局IP`也会经过`NAT路由器`转变成为`私有IP地址`再被转发。
3. 在`NAT路由器`的内部有一张，自动生成的用来转换地址的表，例如`TCP`建立连接的首次握手包一经发出，就会生成这个表，收到关闭连接的时候又会从表中删除。
4. 当私有网络中的多台机器同时都要与外部进行通信时，为了避免`全局IP`不够用，这时采用`NAPT`，包含端口同时转换既可以解决这个问题。

**<font size =4 color = red>`NAT-PT(NAPT-PT)`</font>**

> `NAT-PT`：将`IPv6`的首部转换为`IPv4首部`的技术。
 
通过`NAT-PT`，那些只有`IPv6地址`的主机也可以与`IPv4地址`的其他主机进行通信。

**<font size =4 color = red>`NAT`潜在问题</font>**

- 通信过程中如果`NAT`遇到异常需要重新启动时，所有的`TCP`连接都会重置；
- 转换表的生成与转换操作都会产生一定的开销；
- 无法从`NAT`外部向内部服务器建立连接。


## 5.6、`IP隧道`

> `IP隧道`：路由器在网络层协议的首部后面继续追加网络层首部的通信方法。

假设网络A和网络B都是`IPv6`网络，在中间有个网络C支持使用`IPv4`，网络A和网络B无法直接进行通信，采用`IP隧道`，网络A在整个`IPv6`数据包追加一个`IPv4`首部，就可以转发给网络C。


## 5.7、其他IP相关技术

**<font size =4 color = red>`IP多播`</font>**

**<font size =4 color = red>`IP任播`</font>**

**<font size =4 color = red>通信质量控制</font>**

**<font size =4 color = red>显式拥塞通知</font>**

**<font size =4 color = red>`Mobile IP`</font>**