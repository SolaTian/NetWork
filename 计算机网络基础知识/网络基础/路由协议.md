# 7、路由协议

## 7.1、路由控制

> `路由控制`：为了让数据包正确的到达目标主机，路由器必须在中途进行正确的转发，正确的转发数据的处理就叫做路由控制。

路由器根据路由控制表转发数据包。它根据所收到的数据包中目标主机的IP地址与路由控制表的比较得出下一个应该接收的路由器。

**<font size =4 color = red>路由控制的分类</font>**
|路由控制分类|说明|
|-|-|
|`静态路由`|事先设置好路由器和主机中并将路由信息固定的一种方法<li>需要手动设置，给管理者带来巨大的负担<li>每新增一个网络，就需要将追加的网络设置在所有的路由器上<li>一旦某个路由器发生故障，基本上无法自动绕过发生故障的节点，只有管理员手工设置才能恢复|
|`动态路由`|让路由协议在运行的过程中自动地设置路由控制信息的一种方法<li>管理员必须设置好路由协议，其设定过程根据具体的路由协议来决定`RIP`的路由协议无需过多的设置，`OSPF`的路由协议设置工作会十分繁琐；<li>网络上发生故障，只要存在一个可绕的其他路径，就会自动选择这个路径；<li>新增网络只需在新增网络的路由器上进行动态路由的设置；<li>相互的路由器之间会定期交换必要的路由控制信息，相互发消息，会给网络带来一定程度的负荷。|

**<font size =4 color = red>路由控制范围</font>**

> 自治系统：制定自己的路由策略，并以此为准在一个或多个网络群体中采用的小型单位叫做自治系统，如`ISP`和区域网络。

在自治系统内部，有管理员指定路由控制相关方针。要想接入这些自治系统，就必须要遵循这些路由控制相关方针。

自治系统内部动态路由采用的协议是`域内路由协议`，即`IGP`；自治系统之间的路由控制采用的是`域间路由协议`，即`EGP`。

**<font size =4 color = red>`IGP`和`EGP`</font>**

|路由协议分类|说明|
|-|-|
|`IGP`|外部网关协议，在区域网络内部进行主机识别<li>没有`IGP`，机构内部就不可能进行通信；<li>使用`RIP`，`RIP2`，`OSFP`等众多协议|
|`EGP`|内部网关协议，在区域网络之间进行路由选择<li>没有`EGP`，世界上就不会有不同组织机构之间的通信；<li>使用`BGP`等协议；|



## 7.2、路由算法

路由控制中最具有代表性的两种算法，`距离向量算法`，`链路状态算法`。

**<font size =4 color = red>`距离向量算法(DV)`</font>**

> 距离向量算法(DV)：指根据距离和方向决定目标网络或目标主机位置的一种方法。

路由器之间可以互换目标网络的方向以及其距离的相关信息，并以这些信息为基础制作路由控制表。但是在网络结构比较复杂的时候，在获得稳定的路由信息之前需要消耗一定时间，且容易发生路由循环问题。

`距离向量算法`中每个路由器掌握的消息都不相同，通往每个网络所耗的距离也根据路由器的不同而不同，算法的一个缺点就是不易判断每个路由器上的信息是否正确。

**<font size =4 color = red>`链路状态算法`</font>**

> 链路状态算法：路由器在了解网络整体连接状态的基础上生成路由控制表的一种方法。在这种方法中，每个路由器必须保持同样的信息才能进行正确的路由选择。

该算法中，由于每个路由器的路由信息相同，只要某一台路由器和其他路由器保持同样的路由控制信息，就意味着这台路由器上的路由信息是正确的。所以即使是网络结构复杂，每个路由器也能够保持正确的路由信息，进行稳定的路由选择。

但是，为了实现这个机制，需要从网络代理处获取路由信息表，这个过程相当复杂，复杂的网络结构往往需要高速的`CPU`处理能力和大量的内存。

## 7.3、`RIP`

> `RIP`：距离向量型的一种路由协议，广泛用于`LAN`。

**<font size =4 color = red>广播路由控制信息</font>**

`RIP`通过广播路由控制信息：
1. 每个路由器将自己的路由控制信息定期(30s)向全网广播；
2. 将已知的路由信息经过一跳之后继续广播，
3. 以此类推，逐步传递路由信息。

如果没有收到路由控制信息，连接就会被断开，不过可能是由于丢包导致，`RIP`规定等待5次，如果等待了6次(180s)人未收到路由信息，才会真正的关闭连接。

**<font size =4 color = red>根据距离向量确定路由</font>**

`RIP`根据距离向量算法决定路径，距离的单位为`跳数`，指经过的路由器的个数。`RIP`会根据距离向量生成`距离向量表`，再抽出较小的路由生成`路由控制表`。


**<font size =4 color = red>使用子网掩码时的`RIP`处理</font>**

`RIP`不交换子网掩码的信息，但是可以用于使用子网掩码的网络环境，需要注意以下两点：

1. 从路由器接口的`IP地址`对应分类得出网络地址后，与根据路由控制信息流过此路由器的包中的`IP地址`对应的分类中得出的网络地址进行比较，如果两者的网络地址相同，则以路由器接口的网络地址长度为准。
2. 如果网络地址不同，那么以`IP地址`的分类所确定的网络地址的长度为准。

举例说明：路由器的接口地址为`192.168.1.33/27`，这是一个`C类地址`，它的对应的网络地址为`192.168.1.33/24`，流过这个路由器的`IP地址`分类对应的网络地址与`192.168.1.33/24`进行比较，相同的网络地址，长度都被视为27（以接口网络地址长度为准），不同的网络地址，长度以每个`IP地址`分类所确定的网络地址长度为准。

**<font size =4 color = red>`RIP`中路由变更时的处理</font>**

<font size=3 color=yellow>无限计数问题</font>：

在`RIP`中，如果路由器A将网络A的连接信息发送给路由器B，路由器B增加一跳的基础上发送给路由器C，假设这个时候路由器A和网络A的连接发生了故障，但是无法将网络A的消息发送给路由器B，但是路由器A会收到路由器B曾经获知的消息，使得路由器A就认为自己的信息可以通过路由器B到达网络A，这种收到自己发出去的信息叫做无限计数问题。

解决方法：
1. 最长距离不超过16，即使发生无限计数问题，也可以从时间上进行控制
2. 规定路由器不再把所收到的路由消息按照原路返还给发送端，被称为`水平分割`
3. 针对环路，反向的环路形成迂回的通道，采用毒性逆转和触发更新，使得路由信息尽快收敛


> 毒性逆转：网络中发生链路断开时，发送一个距离为16的消息。
> 触发更新：当路由信息发生变化时，不等待30s而是立刻发送出去，在链路不通时，可以迅速传递路由信息，尽快收敛。



**<font size =4 color = red>`RIP2`</font>**

`RIP`的改良版，具有以下特点：
- 使用多播，不再使用广播交换路由信息
- 支持子网掩码，支持在交换路由时加入子网掩码信息
- 路由选择域，在同一个网络上可以使用逻辑上独立的多个`RIP`
- 外部路由标志
- 身份验证密钥

## 7.4、`OSPF`

**<font size =4 color = red>`OSPF`是链路状态型路由协议</font>**

`OSPF`是一种链路状态型路由协议。支持子网掩码。

`OSPF`中每个路由器掌握着相同的网络拓扑，通过给每条链路赋予一个权重，并且始终选择一个权重最小的路径作为最终路由。`RIP`是选择经过路由器个数最少的路径。

**<font size =4 color = red>`OSPF`基础知识</font>**

在`OSPF`中，连接到同一个链路的路由器叫做相邻路由器，在一个相对简单的网络结构中，相邻路由器可以交换路由信息，而在复杂网络中，如一个链路中加入了以太网或者`FDDI`等路由器时，就不需要在所有相邻的路由器中交换路由信息，而是指定一个路由器，并以它为中心进行交换。

`RIP`中的包类型只有一种，利用路由控制信息，一边确认是否连接了网络，一边传送网络信息。存在以下缺点：
- 网络个数越多，每次需要交换的路由控制信息就越大；
- 在网络稳定的时候，也需要定期交换相同的路由控制信息，造成网络带宽的浪费。

|`OSPF`包类型|包名|功能|
|-|-|-|
|1|问候|确认相邻路由器、确认指定路由器|
|2|数据库描述|链路状态数据库的摘要信息|
|3|链路状态请求|请求从数据库中获取链路状态信息|
|4|链路状态更新|更新链路状态数据库中的链路状态|
|5|链路状态确认应答|链路状态信息更新的确认应答|

路由器通过发送`问候包`确认是否连接，每个路由器为了同步路由控制信息，利用`数据库描述包`相互发送路由摘要信息和版本信息。如果版本比较老，则首先发送一个`链路状态请求包`请求路由控制信息，然后由`链路状态更新包`接收路由状态信息，最后再通过`链路状态确认包`通知大家本地已经接收到路由控制信息。

通过这种机制，`OSPF`相比于`RIP`可以大大减少网络流量，并可以迅速更新路由信息。


**<font size =4 color = red>`OSPF`工作原理</font>**

`OSPF`工作原理：
1. `LAN`中每隔10s发送一个`HELLO`包，如果没有`HRLLO`包到达，则进行连接是否断开的判断，允许空等3次，知道第4次仍无任何反馈就认为断开连接。之后进行连接断开或者恢复连接操作。
2. 由于链路状态发生变化，路由器就会发送一个`链路状态更新包`通知其他路由器网络状态的变化；
3. `链路状态更新包`分成两类：一个`网络LSA（网络链路状态通告）`，另一个是`路由器LSA（路由器链路状态通告）`，
   - `网络LSA`是以网络为中心生成的信息，表示这个网络都与哪些路由器相连
   - `路由LSA`是以路由器为中心生成的信息，表示这个路由器与哪些网络相连
4. 每个路由器就可以生成一个可以表示网络结构的`链路状态数据库`，可以根据这个数据库，采用`Dijkstra`算法生成相应的路由控制表。
5. 相比于距离向量，这种生成的路由控制表更加清楚，但是当网络规模增大时，算法处理时间变长，对于`CPU`和内存的消耗会变大。


**<font size =4 color = red>将区域分层进行细分管理</font>**

链路状态路由协议的问题在于，网络越来越大时，路由控制信息的计算就越来越困难，`OSPF`协议为了减少计算负荷，引入了区域的概念。

区域是指将连接在一起的网络和主机划分成小组，使一个自治系统`AS`内可以拥有多个区域，不过具有多个区域的自治系统必须要有一个主干区域，并且所有的其他区域都必须与这个主干区域相连接。


连接区域和主干区域的路由器成为`区域边界路由器`；而区域内部的路由器叫做`内部路由器`；只与主干区域连接的路由器叫做`主干路由器`；与外部相连的路由器就是`AS边界路由器`。

每个区域内的路由器都持有本区域网络拓扑的数据库，关于区域之外的路径信息，只能从区域边界路由器那里获取它们的距离。这样内部路由器所持有的网络拓扑数据库就会变小。

## 7.5、`BGP`

>`BGP`：边界网关协议是连接不同组织机构的一种协议。属于外部网关协议`EGP`，主要用于`ISP`之间相连接的部分。

**<font size =4 color = red>`BGP`与`AS`号</font>**

`BGP`的最终路由控制表由网络地址和下一站的路由器组来表示，它会根据所要经过的`AS`个数进行路由控制。每个自治系统会有一个16位的`AS`编号，`BGP`就根据这个编号进行路由控制。不同的`AS`就相当于一个国家，与其他的`AS`相连时就相当于建立外交关系。

**<font size =4 color = red>`BGP`是路径向量协议</font>**

根据`BGP`交换路由控制信息的路由器叫做`BGP`扬声器。`BGP`扬声器为了在`AS`之间交换`BGP`信息，必须与所有的`AS`建立对等的`BGP`连接。


`BGP`的数据包到达目标网络时，会生成一个中途经过所有`AS`的编号列表，这个表格叫做`AS路径信息访问列表`，针对同一个目标地址存在多条路径时，`BGP`会在列表中选择出一个较短的路由。

在做路由选择时的度量，`BGP`表示为路由器个数，`OSPF`表示为每个子网的成本，`BGP`则使用`AS`进行度量标准。`AS路径信息访问列表`不仅包括转发方向和距离，还包括`AS`的编号，像这种要经过的路径信息访问列表进行路由控制的协议成为`路径向量型协议`。

## 7.6、`MPLS`

`路由技术`基于`IP地址`中最长匹配原则进行转发，之前提到的协议都属于路由技术。

> 标记交换技术：对每个`IP`包都设定一个叫做`标记`的值，然后根据`标记`进行转发。其中最具代表性的为`MPLS`。

由于采用标记的转发通常无法在路由器上进行，所以`MPLS`无法被整个互联网采用。

**<font size =4 color = red>`MPLS`的网络基本动作</font>**

`MPLS`网络中实现`MPLS`功能的路由器叫做`标记交换路由器（LSR）`，与外部网路连接的那部分`LSR`叫做`标记边缘路由器（LER）`，`MPLS`在`LER`上对数据包进行追加标记和删除标记的操作。

**<font size =4 color = red>`MPLS`的优点</font>**

`MPLS`的优点：
- 转发速度快；
- 利用标记生成虚拟的路径，并在它的上面实现`IP`等数据包的通信。