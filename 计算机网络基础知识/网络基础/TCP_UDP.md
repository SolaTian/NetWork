# 6、`TCP`和`UDP`

`TCP`提供可靠的通信传输，`UDP`常被用于让广播和细节控制交给应用的通信传输。

## 6.1、传输层的协议

在`IP包`首部有一个协议字段，用来表示网络层的上一层所采用的传输层协议，根据这个协议就可以知道传输的数据部分究竟是`TCP`还是`UDP`。而`TCP`和`UDP`应该发送给应用层的具体哪个应用，也会有编号，这个编号就是端口号。

**<font size =4 color = red>通信处理</font>**


客户端发送请求之后，服务端也必须启动相应的程序，才能处理请求。这些服务端程序在`UNIX`中叫做`守护进程`，`UNIX`系统中有一个`互联网守护进程`（`inetd`），叫做超级守护进程，在接收到客户端请求之后会`fork`新的进程，并转换成为对应的各个守护进程，具体是哪个守护进程可以通过端口号来识别，如`HTTP`，`TELNET`，`FTP`等应用层协议。

**<font size =4 color = red>`TCP`和`UDP`的区别</font>**

1. `TCP`是面向连接的，可靠的`流协议`（`流`就是不间断的数据结构），实行“顺序控制”或”重发控制“机制，此外还具备`流量控制`，`拥塞控制`等功能。
2. `UDP`是不具有可靠性的数据报协议。`UDP`主要用于对于高速传输和实时性要求较高的通信或者广播通信，如`IP电话`，采用的是UDP，不会出现声音延迟到达的情况，即使部分数据丢失，也只会影响一小部分的通话。多播和广播通信中也采用的是`UDP`而不是`TCP`，`RIP`和`DHCP`等基于广播的协议也要依赖于`UDP`。

在`TCP/UDP`通信时会广泛使用套接字(`socket`)的API。

## 6.2、端口号

数据链路和IP中的地址，分别指`MAC`和`IP地址`，`MAC地址`用来识别同一个链路中的不同计算机，`IP地址`用来识别`TCP/IP`网络互连的主机和路由器。

> 端口号：传输层中类似于地址的概念，用来区分同一台计算机中进行通信的不同应用程序，也可以称为程序地址。

通过`源IP地址`，`目标IP地址`，`协议号`，`源端口号`，`目标端口号`5个信息来识别一个通信。只要其中某一项不同，则被认为是其他通信。

**<font size =4 color = red>端口号的确定</font>**

|确定端口号方法|说明|
|-|-|
|标准既定的端口号（静态方法）|如`HTTP`(80)，`TELNET`(23)，`FTP`(21)等协议的端口号就是固定的,这些属于知名端口号，其他应用程序应该避免使用知名端口号进行其他通信，以免产生冲突。|
|时序分配法（动态分配）|客户端应用程序完全不需要自己设置端口号，交给操作系统进行分配，动态分配的端口号取值范围在49152和65535之间|

**<font size =4 color = red> 端口号和协议</font>**

端口号相同，协议号不同也会根据传输协议的不同，进行不同的处理，如`TCP`和`UDP`使用同一个端口号也是可以的。但是知名端口号和传输层协议无关，只要端口一致都会分给同一个应用程序进行处理，`HTTP`通信必须使用`TCP`，`UDP`的80端口未被投入使用。


## 6.3、`UDP`和`UDP首部`

**<font size =4 color = red> `UDP`的特点</font>**

`UDP`的特点：
1. 不提供复杂的控制机制，将部分控制转移给应用程序去处理；
2. 利用`IP`提供面向无连接的通信服务；
3. 收到应用程序发来的数据的那一刻，立即按照原样发送到网络上的一种机制；
4. 传输过程中发生丢包，也不会负责重发，且接收到的包顺序乱掉也不会纠正，而而是交给`UDP`的应用程序去处理；
5. 用户说什么听什么的机制。

**<font size =4 color = red> `UDP`的应用场景</font>**

`UDP`主要用于：
- 包总量较少的通信(`DNS`和`SNMP`等)
- 视频，音频等多媒体通信(`即时通信`)
- 限定于`LAN`等特定网络中的应用通信
- 广播通信(广播，多播)

**<font size =4 color = red> `UDP首部`</font>**

`UDP首部`由源端口号，目标端口号，包长和校验和组成。

![](https://upload-images.jianshu.io/upload_images/22751020-8fb24b507cd4c0ca.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp "UDP首部")

- `源端口号`：16位，字段是可选项，没有时设置为0，用于不需要返回的通信中。
- `目标端口号`：16位
- `包长度`：`UDP首部`的长度和数据的长度之和，单位为字节。
- `校验和`：为了提供可靠的`UDP首部`和数据而设计。若不使用，则校验和全部为0。



## 6.4、`TCP`和`TCP首部`

`TCP`通过校验和，序列号，确认应答，重发机制，连接管理以及窗口控制等机制进行可靠性传输。

**<font size =4 color = red>确认应答和序列号</font>**

> 确认应答（`ACK`）：发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知。这个消息就是确认应答。

`TCP`通过肯定的确认应答(`ACK`)实现可靠的数据传输。若没有收到`确认应答`，发送端就可以认为数据已经丢失，进行重发。没有收到`确认应答`有可能是因为数据丢失，有可能已经收到数据，但是`确认应答`在返回的途中丢失。

如果因为`确认应答`丢包，或者`确认应答`的延时导致的发送端主机重发，则接收端主机会反复收到同样的数据，通过序列号判断是否已经接收，是否需要接收，接收端主机将自己下一步应该接收的序号作为`确认应答`返回。

**<font size =4 color = red>重发超时</font>**

> 重发超时：重发数据之前，等待确认应答到来的那个特定时间间隔。

不同的网络结构，返回确认应答的最小时间是不同的。因此重发超时时间不同，需要计算。`TCP`每次发送包的时候都会计算往返时间以及偏差，将两者相加，最后的重发超时时间就是比这个总和要稍微大一点的值。

重发不会一直进行，当达到一定的重发次数之后，如果仍然没有收到`确认应答`返回，就会判断网络或者对端主机发生了异常，强制关闭连接。


**<font size =4 color = red>连接管理</font>**

`TCP`在数据通信之前，通过`TCP首部`发送一个`SYN包`作为建立连接的请求等待确认应答。如果对端发来确认应答，则认为可以进行数据通信，否则不会进行数据通信。此外，在数据通信结束时会进行断开连接的处理(`FIN包`)，建立和断开连接的过程如下图所示。


![TCP三次握手建立连接](https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcwNjA1MTEwNDA1NjY2?x-oss-process=image/format,png "TCP三次握手建立连接")
![TCP三次握手建立连接动图](https://img-blog.csdnimg.cn/114bd9b53c554319ae0db15b57b472b8.gif#pic_center "TCP三次握手建立连接动图")

![TCP四次挥手断开连接](https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcwNjA2MDg0ODUxMjcy?x-oss-process=image/format,png "TCP四次挥手断开连接")
![TCP四次挥手断开连接动图](https://img-blog.csdnimg.cn/0c17d72769aa4bd2b95bbaee1749b39d.gif#pic_center "TCP四次挥手断开连接动图")

[参考链接](https://blog.csdn.net/qzcsu/article/details/72861891)

**<font size =4 color = red>`TCP`以段为单位发送数据</font>**

在建立`TCP`连接的时候，也可以确定发送数据包的单位，称为最大消息长度(`MSS`).理想的情况下，最大消息长度是`IP`中不会被分片处理的最大数据长度。

在建立`TCP`连接的时候，会在`TCP首部`写入`MSS`选项，告诉对方自己的接口能够适应的`MSS`的大小，在两者之间选择一个较小的值投入使用。


**<font size =4 color = red>利用窗口控制提高速度</font>**

`TCP`中每发1个段就会进行1次应答的处理，有个缺点就是，包的往返时间越长通信性能就越低。

为了解决这个问题，确认应答不再是每个分段，而是以更大的分段进行确认，转发时间就会大幅度的缩短。

> 窗口大小：无需等待确认应答而可以继续发送数据的最大值。窗口大小以段为单位，为4个段。

通过对多个段同时进行确认应答的功能。在<font size=3 color =yellow>整个窗口的确认应答</font>没有到达之前，如果其中部分数据出现丢包，那么发送端仍然需要重传。为此，发送端需要设置缓冲保留待被重传的数据。

同时为了不超过接收主机的接收能力，窗口大小是由接收端主机定的，是由接收主机将自己能够接收的缓冲区大小放入`TCP首部`通知给发送端。

> 滑动窗口机制：在收到窗口确认应答的情况下，将窗口滑动到确认应答中的序列号的位置。这样可以顺序地将多个段同时发送，提高通信性能。这种机制被称为滑动窗口控制。

在滑动窗口以外的部分包括尚未发送的数据以及已经确认对端收到的数据。当数据发出后若如期收到确认应答就可以不进行重发，此时数据就可以从缓存区删除。


**<font size =4 color = red>窗口控制与重发控制</font>**


窗口在一定程度上较大时，即使有少部分的`确认应答`丢失也不会进行数据重发。可以通过下一个确认应答进行确认。

`高速重发控制`具体工作的流程：
- 当窗口中的某一个报文段丢失时，发送端首先不会进行重发;
- 接收端会一直发送下一个该接收的报文段的序号，若没有接收到该报文段，则会一直发，提醒发送端下一个该要收到的是什么数据;
- 发送端在连续3次接收到同一个应答报文，则会进行重发。


**<font size =4 color = red>流控制</font>**

`窗口大小`由接收端主机在`TCP首部`通知给发送端主机，当接收端主机缓冲区发生溢出时，`窗口大小`的值也会被设置更小通知给发送端。这种通过接收端主机的指示控制发送数据的量的机制就是`TCP流控制`。

当接收端的缓冲区满的时候，只有向发送端主机发送更新通知后通信才能继续进行。这个窗口的更新通知如果在传送途中丢失，可能导致无法继续通信。为了避免此类问题，发送端主机会时不时发送一个叫做`窗口探测`的数据段，来获取接收端主机最新的`窗口大小`信息。


**<font size =4 color = red>拥塞控制</font>**

有了`窗口控制`，可以连续发送大量数据包，但是在共享的计算机网络中，如果通信刚开始的时候就发送大量数据，有可能会引起网络的拥堵。

> 慢启动：最初的发送端的拥塞窗口为1，每收到一个确认应答，拥塞窗口的值会增加1个段。

在发送数据包时，将拥塞窗口的大小和接收端主机通知的窗口大小作比较，然后按照它们当中的较小值，发送比其还要小的数据量。

> 慢启动阈值:随着包的每次往返，拥塞窗口也会增大，导致网络拥堵，设定这个阈值，当拥塞窗口的值超过阈值，在每一次收到确认应答时，只允许以某个比例放大拥塞窗口。




**<font size =4 color = red>`TCP`首部格式</font>**


![](https://upload-images.jianshu.io/upload_images/22751020-61f7187ed07cbbe4.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp "TCP首部")


- `源端口号`：16位
- `目标端口号`：16位
- `序列号`：32位，指发送数据的位置，每发送一次数据，就累加一次该数据字节数的大小。由建立连接时计算机生成的随机数作为初始值，通过`SYN`包传给接收端主机。再将每转发过去的字节数累加到初始值上。`SYN包`和`FIN包`虽然不携带数据，也会作为一个字节增加对应的序列号。
- `确认应答号`：32位，指下一次应该收到的数据的序列号。
- `数据偏移`：4位，单位是4字节，表示`TCP`所传输的部分应该从哪个位开始计算。可以看做`TCP`首部的长度，如图，如果不算选项字段的话，总共20字节，这里填5。
- `保留`：该字段主要是为了以后扩展的时候使用，长度为4位。一般设置为0.
- `控制位`：8位，有8个控制标志位。
- `窗口大小`：16位，用于通知从相同`TCP首部`的`确认应答号`所指位置开始能够接受数据的大小（字节），如果窗口是0，则表示发送`窗口探测`。
- `校验和`：与`UDP`不同，`TCP`的校验和无法关闭。
- `紧急指针`：16位，只有在`URG`控制位为1的时候有效，表示本报文段中紧急数据的指针。从数据部分的首位到紧急指针所指的位置为紧急数据。
- `选项`：最大40字节，用于提高`TCP`传输性能。


`TCP`通信的最大吞吐量计算公式：
$窗口大小 \div 往返时间=吞吐量$


 
## 6.5、其他传输层协议

**<font size =4 color = red> `UDP-Lite`</font>**

`轻量级UDP`，提供的和`UDP`几乎一样的服务，计算校验和的范围由应用自行决定，可以只针对不允许发生错误的部分进行校验和的检查，对于其他部分，即使发生了错误也不丢弃，而是给应用继续处理。

**<font size =4 color = red> `SCTP`</font>**

`流控制传输协议`，与`TCP`一样，对一种提供数据到达与否相关可靠性检查的传输层协议。

特点：
- 以消息为单位收发；
- 支持多重宿主，在有多个`NIC`的情况下，即使其中能够使用的`NIC`发生变化，也可以继续通信；
- 支持多数据流通信，`SCTP`只需要一个连接就可以通信，与`TCP`不同；
- 支持多个`IP地址`同时进行通信，主要用于进行通信的应用之间发送众多较小消息的情况。

**<font size =4 color = red> `DCCP`</font>**

`数据报拥塞控制协议`，辅助`UDP`的崭新传输层协议，面向连接，能够进行网络拥塞控制。

