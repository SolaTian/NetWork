# 路由器

## 路由器简介

路由器主要负责`OSI`中网络层的处理工作，并根据路由信息表在不同的网络之间转发`IP`分组的网络硬件。网络一般指`IP`子网，也可以称为广播域。

当需要一个`LAN`连接到另外一个`LAN`，就需要使用路由器设备。

|路由器的主要功能|说明|
|-|-|
|路由信息管理|管理静态路由和动态路由。从相邻路由器获取路由更新消息，向相邻路由器发送路由更新消息|
|对分组进行分类|处理、队列以及判断分组是否可以转发。|
|`L3`交换|封装用于输出的`L2`数据，计算`L3`的校验总和，更新`TTL`以及`HOP`数|
|管理、计费、收集统计信息|接口的统计信息、`Telnet`、`SNMP`、`ping`、`trace route`、`HTTP`|

## 路由器分类

### 根据性能分类

|根据性能分类|用途|
|-|-|
|高端路由器（机框式路由器）|作为骨干网络的核心路由器使用，在数据中心，`IX`、大型企业、电信运营商网络中完成网络互联任务<li>组成要素包括路由引擎、交换结构、线卡、背板<li>可以控制接口的数量，还可以增强设备的交换容量<li>具有路由引擎的冗余功能<li>支持热插拔，当某一个模块发生故障，无需关闭路由器电源，在其他模块正常工作的情况下，只替换发热的扩展卡即可修复|
|中端路由器|一般作为企业的中心路由器，是整个企业网络的中心。<li>有“固定式”路由器不支持添加额外端口，“模块式”路由器支持添加端口进行扩充|
|低端路由器|中小企业或者大型企业分支机构使用的路由器<li>也分为可以改变接口类型和端口数的模块式路由器以及无法改变接口类型和数量的箱式路由器|
|宽带路由器|小规模使用、家庭使用|


### 面向电信运营商的路由器产品分类

|分类|用途|
|-|-|
|核心路由器|位于骨干网中，用来构成核心网络<li>核心网络用于各个业务网络的互联，承担高速转发各个网络之间通信流量的任务|
|边缘路由器|指在骨干网络边缘配置的路由器。<li>承担容纳用户网络线路、连接骨干网的任务<li>容纳众多用户的网络线路需要做到高速中继转发处理、控制分组的优先级、分组过滤、认证、加密等处理。|
|用户边缘路由器|在用户网络处配置的路由器，用于连接服务供应商的边缘路由器|


### 面向企业的路由器产品分类

|分类|用途|
|-|-|
|接入路由器|距离用户最近的路由器称为接入路由器<li>保障用户接入所需网络的路由器<li>提供认证，接入控制等功能，一般部署在企业的分支结构或下属部门中<li>有时在家中或者出差需要接入公司网络而使用远程接入路由器，这类网络使用拨号连接、`PPTP`、`IPsec`、`SSL`等协议通过`VPN`完成接入|
|汇聚路由器|在规模很大的网络中，往往会在核心网络和接入网络之间构建一个汇聚网络。<li>汇聚路由器负责在汇聚网络中汇聚接入网的路由选择信息，完成分组过滤等工作，从而进行多个网络或者`VLAN`之间的连接|
|核心路由器|配置在网络中心位置的路由器<li>核心路由器构建的核心网主要负责高速传送与接入网或汇聚网之间的通信数据。|
|拨号路由器|个人计算机等设备通过电话线路接入网络的方式称为拨号连接，现在几乎不再使用。|
|宽带路由器|使用`PPPoA`或`PPPoE`就可以连接电信运营商网络的路由器|
|移动路由器|在出差或外出时用于连接互联网的便携式路由器称为移动路由器|



## IP路由选择的基础知识

### IP地址管理

#### 地址分类和自然掩码

|分类|说明|
|-|-|
|`A类地址`|`0.0.0.0`-`127.255.255.255`，8bit网络部分，24bit主机部分|
|`B类地址`|`128.0.0.0`-`191.255.255.255`，16bit网络部分，16bit主机部分|
|`C类地址`|`192.0.0.0`-`233.255.255.255`，24bit网络部分，8bit主机部分|
|`D类地址`（用于多播）|`224.0.0.0`-`239.255.255.255`，|
|`E类地址`（保留）|`240.0.0.0`-`255.255.255.255`|

#### `CIDR`和子网掩码

`CIDR`不采用以往的地址分类，而是基于可变长子网掩码进行任意长度的`IP地址`前缀，即网络部分的分配。主机部分可以是任意长度。


子网掩码一定是以连续的`1`开始，又以连续的`0`结束。或者可以用斜线`/`来记。如`10.1.1.1`，子网掩码为`255.255.0.0`，那么可以记为`10.1.1.1/16`

不使用`CIDR`，`A类地址`，`B类地址`，`C类地址`分别用8bit，16bit，24bit来表示网络部分的子网掩码，也称自然掩码。


使用分类地址称为有类路由选择，使用无类地址称为无类路由选择。

网络地址部分相同的`IPv4`地址可以认为是同一个子网。


#### 私有地址和全局地址

|地址分类|私有地址范围|
|`A类地址`|`10.0.0.0`-`10.255.255.255`(`10.0.0.0/8`)|
|`B类地址`|`172.16.0.0`-`172.31.255.255`(`172.16.0.0/12`)|
|`C类地址`|`192.168.0.0`-`192.168.255.255`(`192.168.0.0/16`)|

除了私有地址以外，其他均为全局地址。私有地址的出现是为了缓解`IPv4`地址枯竭的问题。


#### 单播、广播、多播、任播

|分类|说明|
|-|-|
|单播|向特定`IP`的一台主机发送数据<li>`IPv4`地址中使用`A类`，`B类`，`C类`|
|广播|对网段内不定的多个通信对端发送数据<li>使用`255.255.255.255`或者主机部分全部为`1`的地址（如`192.168.1.255/24`）|
|多播|使用专用`IP地址`向多个通信对端发送相同的数据<li>`IPv4`中使用`D类地址`|
|任播|只在最初发送多份数据，随后仅和响应时间最快的主机继续通信<li>只在`IPv6`中存在|


#### 能够设置IP地址的接口

|名称|说明|
|-|-|
|`L3接口`|能够进行`L3`处理的物理接口。在交换机端口中，一个交换机虽然能够有多个物理端口，但是仅可分配一个`IP地址`。当链路没有连通，该`IP地址`不可达|
|环回接口|路由器用来表示自己本身的虚拟接口。<li>个人计算机中，`IPv4`一般记为`127.0.0.1`，`IPv6`中记为`::1`；<li>可以设定多个环回接口；<li>在链路连通时，该虚拟接口到路由器所带的任意一个物理接口均是可达的|
|`VLAN接口`|在可以进行`VLAN`间路由选择设置的路由器中，为每个`VLAN`分配`IP地址`所使用的虚拟接口|
|汇聚接口|将多个物理接口进行链路汇聚而形成的逻辑接口|
|子接口|使用`VALNID`将一个物理接口分割成多个带有标签的逻辑接口时，这些逻辑接口就称为子接口|
|辅助地址|当在路由器中可以配置`IP地址`的接口存在2个或以上时，可以同时分配不同的`IP地址`，这时第2个地址称为辅助地址，该地址可用于网络迁徙或网络管理|

#### 访问列表和NAT

路由器在转发或者丢弃分组时会使用访问列表来进行分组的过滤操作。

将分组从私有地址转发到全局地址，进行地址转换操作时，会使用`NAT`技术。

#### ARP表管理

> `ARP`是通过`IP地址`获取`MAC地址`的网络协议。

路由器在发送`IP分组`时，会用`ARP`解析以太网数据帧所需要发送的目的`MAC地址`，负责使用`ARP`解析的路由器在收到该请求之后，会向网络中的其他路由器或者主机广播发出类似这样的询问消息，谁有`IP地址``192.168.1.254`，而持有该`IP地址`的设备会做出如`192.168.1.254`的`MAC地址`是...这样的应答。

由于在转发`IP分组`时，执行`ARP`的效率很低，所以一旦`ARP`解析完成，会将解析结果以表项的形式保存在设备的`ARP表`中。但是会有一定的时限，称为`Age Time`，超时则再次解析`ARP`。

`ARP`是以每个网络接口为单位进行保存的。

#### DHCP（动态主机配置协议）

> `DHCP`：是为主机（客户端）自动配置`IP地址`、子网、域名、`DNS服务器`、默认网关等信息的网络协议。

路由器`DHCP`的功能主要分为三个方面：
1. 作为`DHCP服务器`为客户端分配`IP地址`的`DHCP服务器`功能
2. 作为`DHCP客户端`从其他`DHCP`服务器中获取`IP地址`的`DHCP客户端`功能
3. 在`DHCP服务器`和`DHCP客户端`之间完成中继广播消息的`DHCP中继代理`功能

#### PPPoE（以太网上的点对点协议）

> `PPPoE`：是在`LAN`上完成用户认证并分配`IP地址`的网络协议。

使用`PPPoE`协议能够提供网络接入服务，使设备接入互联网服务供应商的网络，享受`FTTH`、`ADSL`等长时间在线网络服务。

`PPPoE`的连接流程：
1. 终端向`IP通信网`请求开始建立`PPPoE`会话
2. `IP通信网`与终端完成几次交互之后建立起`PPPoE`会话
3. 开始建立`PPP`会话
4. 请求认证协议
5. 告知`IP通信网`侧的IP地址
6. 请求终端设备所使用的`IP地址`
7. 返回分配给终端设备的`IP地址`信息
8. 告知终端设备所接收的`IP地址`信息
9. 建立`PPP`对话


### IP路由选择

路由器根据接收到的IP分组中目的地址信息，从路由表中选择最合适的路径，并选择从哪个网络接口转发，这一系列过程叫做路由选择。


`IP路由选择`可以分为：
- 针对单播通信的`单播IP路由选择`
- 针对多播通信的`多播IP路由选择`

### 路由表

路由表包含了路由选择的必备信息，由以下各项组成：
1. `目的IP地址`：`IP分组`的目的地址
2. 子网掩码：表示`目的IP地址`中有多少bit表示网络部分。1和2组合起来能够表示目标子网信息。
3. 网关：分组下一步需要转发的`IP地址`。包含转发接口的`子网IP地址`，通常是相邻路由器的网络接口的`IP地址`。网关也可以称为下一跳。
4. 网络接口：转发该分组路由器上的接口
5. 度量值：当有多条路径可以到达相同目的地（`目的IP地址`和子网掩码相同）时不同路径的优先级。该值越小表示优先级越高。

以上5条构成一条路由表的表项。

### 最长匹配与默认网关

当`IP分组`到达路由器时，路由器参考`IP目的地址`信息，从路由表中找出包含网络地址的路由表表项。若路由表中出现多条表示同一个目的网络地址的表项时，则选择子网掩码最长，度量值最小的表项，这种选择最长子网掩码表项的方式成为最长匹配。

如果路由器表中不存在满足条件的表项，则根据路由表中默认的表项信息转发分组。默认路径的`IP地址`表示`0.0.0.0`，子网掩码为`0.0.0.0`，使用`CIDR`时记为`0.0.0.0/0`。经默认路径的转发也称为默认网关转发。如果路由表中不存在默认路径，路由器会告知转发错误并丢弃该分组。

### 静态路由

网络管理员在路由器中手动设置路由表项信息的方式称为静态路由选择。

使用静态路由的基本路由选择流程：
1. 个人计算机机A发出分组
2. 路由器A接收到该分组，计算`IP首部`校验总和，确认结果是否正确
3. 路由器A参考路由表，获取下一跳的接口信息
4. 路由器A将`IP首部`的`TTL`值减1
5. 路由器A参照`ARP表`，获取下一跳的`MAC地址`信息，如果无法获得该信息，则进入`ARP`流程
6. 路由器A根据下一跳的`MAC地址`信息生成以太网数据帧，并将数据帧从接口转发至网络。

### 动态路由

路由器之间相互交换信息自动生成路由表表项信息。路由器之间进行信息交换的协议称为`路由选择协议`。

网络中有时会使用静态路由和动态路由混合的路由选择方式。在路由表项中会标注哪条属于静态路由，哪条属于动态路由，以及使用了哪一种路由选择协议。

使用动态路由选择，网络中路由表会逐渐增大，最终整个网络所有的路由器会携带完整形态的路由表，这一过程称为`收敛`或者`汇聚`，花费的时间称为`汇聚时间`。`汇聚时间`越短，路径越稳定。`汇聚时间`与路由器数量，路由算法等有关。

动态路由会在下列情况下进行路由信息交互
- 网络内首次运行路由选择协议时
- 网络中添加新的路由器或者链路
- 网络内路由器被卸下或者链路被切断导致发生故障时

> 自治系统（`AS`）：指`ISP`或者学术科研等在大型机构中使用的独立网络，用`AS`编号识别。

|动态路由的分类|说明|
|-|-|
|`IGP`（内部网关协议）|自治系统（`AS`）内部运行，如`RIP`（路由信息协议）和`OSPF`（开放式最短路径优先）|
|`EGP`（外部网关协议）|自治系统（`AS`）之间运行，如`BGP`（边缘网关协议）|

|`IGP`分类|说明|
|-|-|
|距离矢量型|根据距离和方向两个因素进行路由选择。<li>方向指从哪个接口转发，距离是指分组经历的跳数。<li>路由选择时，直接选择距离目的地跳数最少的路径；<li>如`RIP`|
|链路状态型|事先制作整个网络的路径地图，然后根据地图中的路径进行路由选择，区别于距离矢量型中每个路由器掌握各自的路由信息，在链路状态下，所有的路由器持有同一份网络路径地图；<li>如`OSPF`|
|混合型|混合以上两种类型|

**<font size =4 color = red>`RIP`</font>**

`RIP`使用的度量值是到达网络需要经过的跳数（需要经过多少个路由器转发），一般`RIP`会在30s内更新一次路由信息，当距离目的地2跳时，路由信息的获取需要30s，当距离目的地5跳时，需要120s，`RIP`定义了16跳无限距离。当某个网络节点从相邻节点收到度量值为16跳以上的表项信息时，表示该表项目的地址的网络不可达。


`RIP`的实现非常简单，即使是内存很小的宽带路由器，也有很多能够支持静态路由和`RIP`的产品。


**<font size =4 color = red>`OSPF`</font>**

`OSPF`是采用链路状态型的路由协议。适用于网络规模大的网络。收敛时间也比`RIP`的收敛时间短。

**<font size =4 color = red>`BGP`</font>**

`BGP`是`EGP`协议。运行`BGP`的路由器会同时拥有`IGP`和`EGP`两张路由表。

### IP隧道和VPN 

> 隧道技术：某个通信协议被其他通信协议封装后进行转发传输的技术。

在网络中两台路由器之间设置隧道，就可以在路由器之间根据隧道协议构建一条虚拟的通信链路。路由器A在接收到原始分组之后，以封装的形态通过隧道协议转发到路由器B，路由器B进行解封转，还原分组形态，以原始形态再次转发到实际的目的地。

隧道技术多用于构建`VPN`，尤其是使用`IPsec`构建加密的`VPN`提供给用户。这时，`PC-A`和`PC-B`之间分配的私有地址处于一个网络中，路由器A和路由器B使用全局地址，在互联网上相连并负责数据的传输。


`GRE`（通用路由封装）：能够将任意的协议封装到`IP分组`。


`PPTP`（点对点隧道协议）：使用`PPP`数据帧封装`IP`分组，在网络上通过隧道传输。与`RAS`（远程访问服务）服务器进行`PPP`连接。

`RAS服务器`：狭义上指使用`PPTP`进行连接的`PPTP服务器`，广义上包括了能够接受远程终端通过各种隧道协议进行访问的`VPN`集线器和终端服务器。


`IPv6 over IPv4`：指通过`IPv4`的网络传输`IPv6`的通信机制。


### IP多播

`IP多播`：是向多个接收者发送相同数据的过程，一般用于同时传输动态画面等情况。构成多播的网络路由器可以将特定主机发送的多播分组复制并转发到其他多个网络节点。


## 路由器搭载的附加功能

### 支持TCP/IP以外的协议族

如支持`Apple Talk`，`DECnet`等协议。

### LAN交换

大多数宽带路由器都有一个`WAN`端口和若干个`LAN`端口，可以将多台个人计算机连接`LAN`端口，并通过`WAN`端口接入到互联网。与此同时，各个`LAN`端口之间也能够交换数据。

### 支持LAN以外的物理层和数据链路层协议

如今大多数互联网是通过以太网完成互连的，以太网原本是用于局域网（`LAN`）的技术，但是自从出现万兆以太网之后也开始逐渐应用于广域网（`WAN`）。

除了以太网之外，主要在广域网中使用的数据链路层协议包括`HDLC`，`PPP`，`ATM`，`MPLS`等协议，路由器中支持的物理层协议有`SONET/SDH`


### 拨号接入

拨号接入互联网时，数据链路层使用`PPP`连接个人计算机和`ISP`的`RAS`，当`RAS`作为路由器使用时，大多数需要将`RADIUS`（远程认证拨号用户服务）作为认证服务器进行协同使用，在`RAS`和`RADIUS`服务器之间采用`RADIS`协议完成认证和计费管理。


### 冗余

路由器冗余是为了在一些情况下，路由器发生故障也可以提供连续不断的业务。

### 认证

认证是指用户在接入网络时，网络要求用户出示设备的认证信息、验证用户输入的认证信息是否正确，确认正确之后允许用户接入网络这一系列过程。认证功能有很多种，例如管理员身份认证、拨号上网接入认证以及`VPN`等用户认证。

>`RADIUS`：远程认证拨号用户服务，路由器可以和外部`RADIUS`服务器协同完成路由器管理员身份认证或客户端用户的账户认证。如在路由器拨号上网或进行`PPP`连接时。


>`TACACS+`：终端访问控制系统。

### QoS

**<font size =4 color = red>优先级与标记</font>**

`IP`首部有一个`ToS`的数据域，该数据域在控制`IP`分组优先级时使用。

**<font size =4 color = red>保持缓存和队列处理</font>**

分组从路由器网络接口转发时，会暂存于内存中的数据缓存中。每个网络接口均有缓存，在缓存中存放数据的过程称为保持缓存。当通信线路上遇到拥塞或者冲突时，分组暂时无法从网络接口转发到线路上，因此需要暂时保存在缓存中，等到线路允许时再次发送。

一般而言，分组在缓存中以`FIFO`的方式处理。`FIFO`方式构成的数据称为队列，而分组在路由器上等待处理的过程称为队列处理。


**<font size =4 color = red>附带优先级的队列处理</font>**

路由器中转发的分组存在各种数据，由流媒体等数据，`FTP`，邮件等数据，若对所有的数据采用同一个标准进行`FIFO`队列处理的话，将会出现路由器为了转发大量`FTP`数据而导致`IP`电话无法使用。为此，路由器需要采用带有优先级的队列处理方式。

**<font size =4 color = red>避免拥塞</font>**

当实际通信的速率超过了网络接口的速率，转发出口的网络接口就会出现拥塞现象。转发出口的队列会积满，之后进入缓存的分组会被丢弃。该路由器所经链路的所有`TCP`连接分组也会被丢弃，路由器会对大量`TCP`连接同时采取进入重发机制或减少窗口尺寸等一系列流量控制措施。当拥塞得到缓解之后，`TCP`连接会逐渐增大窗口尺寸，从而再度导致大量数据到来再次发生拥塞，网络陷入恶性循环。

采用`RED`技术，会始终检测队列中数据量的平均值，当该值超过设置的最小阈值时，将尽早丢弃选中的分组。平均队列长度越大，分组的丢弃率越高，当超过最大阈值时，同样将执行丢弃。

### 虚拟路由器

一般而言，1台路由器内部只能生成一份路由表，但带有虚拟路由器功能路由器可以在1台路由器体内模拟出多台虚拟路由器运行。虚拟路由器会在服务供应商提供`VPN`等业务时使用。

## 用于管理路由器的各种功能

### 用户界面

路由器的`UI`分成`WebUI`和`CLI`（管理员通过使用终端软件访问路由器）

### 日志

将日志传送到`Syslog服务器`上保存。

### 确认CPU使用率

通过`WebUI`，`CLI`命令行或者`SNMP`等获取CPU使用信息。

### 告警

包括温度告警，风扇告警，电源告警。

### 设置时间

路由器时钟信息可以通过手动设置，但是在现网中，路由器之间往往会有日志通信等依赖时间的通信交互。因此要求某台路由器的时间必须与其他路由器保持绝对一致，这时的路由器就需要使用`NTP`完成时钟同步。

在`NTP`服务器的层级构造中，获取正确的时间信息源并与之同步运行的最上层称为`Stratum 1`，`Stratum 2`的`NTP`服务器通过`NTP`协议从`Stratum 1`的`NTP`服务器获得时间信息。以此类推。

路由器还有故障排查，文件传输控制，其他工具包等来协助管理。



## 路由器的架构

|路由器的构成要素|说明|
|-|-|
|CPU|使用嵌入式设备和通信设备专用的处理器或者通用处理器|
|存储器|路由器中有`ROM`，`RAM`，`NVRAM`，闪存，其中路由表缓存位于`RAM`中|
|操作系统、固件|路由器有专用的操作系统，仅包含路由器必备的相关软件。操作系统分为共享单一内存空间的单体式（如`IOS`）和每个进程均有专用内存空间的模块式（如`JUNOS`）|
|网络接口|路由器对应不同数据链路层协议有着不同的网络接口|
|硬件模块|在高端路由器中，路由器的一部分功能并不是使用软件`CPU`处理，而是使用硬件芯片进行高速处理|
|电源|路由器配备电源模块|



