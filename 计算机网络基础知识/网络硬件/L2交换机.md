# 2、`L2交换机`

## 2.1、中继器和网桥的不同点

**<font size =4 color = red>中继器</font>**

> 中继器（`Repeater`）：信号增强装置，在`OSI`的物理层运行。功能就是将被噪声影响的信号重新输出，不再进行额外的数据控制。无法辨别`MAC地址`和`IP地址`。


**<font size =4 color = red>网桥</font>**

> 网桥：连接两个冲突域的装置称为网桥。在`OSI`的数据链路层运行。交换集线器（交换机）也属于网桥。多个网段互联的功能实体就是网桥。

由共享式集线器形成的网段称为冲突域。

**<font size =4 color = red>共享式集线器（集线器）</font>**

> 集线器（`Hub`）：指集中器设备，带有中继器功能的集线器被称为共享集线器，多端口中继器，中继集线器等。


**<font size =4 color = red>交换式集线器（交换机）</font>**

> 交换式集线器：指将连接着两台通信终端的两个端口在内部绑定，使其他端口的信号无法介入，从而防止发生冲突，弥补了共享式集线器的不足。

一般所说的交换机或`L2交换机`均指拥有多个透明网桥的装置。

共享式集线器的不足以及交换式集线器的改进：
- 共享式集线器中，从发送方接收到的数据会直接转发到所有的非发送方端口，即单纯通过复制电器信号来实现发送。
- 交换式集线器通过学习连接的每个网络终端的`MAC地址`，将数据仅发送到发送方所期望的目的终端上，避免将数据发送到无关端口，从而提高网络利用率。
- 如果发送目的`MAC地址`不明，交换式集线器也可以通过广播方式将数据帧转发到所有非发送方端口。

交换机通过确认以太网帧的发送源`MAC地址`，习得交换机端口号和该端口所连硬件`MAC地址`的配对信息，并将该信息记录到其内部的`MAC地址表`中。`MAC地址表`中记录项会有一个超时值，称为`MAC地址`的老化时间。超过老化时间，该记录项会被老化消去。

**<font size =4 color = red>交换机的优点</font>**

|优点|说明|
|-|-|
|冲突域固定|主机直接连接到交换机时，冲突域只会在交换机端口和主机之间形成|
|全双工通信|冲突域中不存在其他主机，主机能够同时进行收发工作|
|阻断错误数据帧|存储转发型交换机能够检查接收到的数据帧是够错误，并及时丢弃|
|独享带宽|收发工作在两个交换机端口分别进行，使得每个端口的带宽都可以有效利用|

## 2.2、交换机中使用的数据帧和传输方式

**<font size =4 color = red>以太网帧种类</font>**
|以太网使用的数据帧类型|说明|
|-|-|
|单播数据帧|发送目的地址为广播或多播以外的数据帧|
|广播数据帧|发送目的地址为广播地址（`FF:FF:FF:FF:FF:FF`）的数据帧|
|多播数据帧|发送目的地址为多播地址的数据帧|
|不完全帧|包含首部信息，长度为63字节以下的数据帧。交换机将这类数据帧识别为坏帧|
|小巨人帧|比通常的`MTU`规定的1518字节稍大的数据帧|
|巨型帧|比通常的`MTU`大很多的数据帧|


**<font size =4 color = red>交换机数据帧传输方式</font>**
|交换机数据帧的传输方式|说明|
|-|-|
|直通转发|交换机只需读取前14字节即可转发至目的地址<li>先进先出方式发送；<li>仅读取14字节就发送，无法检测和丢弃错误数据帧；<li>通信时延最短|
|碎片隔离|交换机读取前64字节<li>先进先出方式处理数据帧；<li>防止转发因为发生碰撞出现的小于63字节的坏帧；<li>数据帧出现`CRC`错误时，只能按照和直通转发一样的方式来处理数据帧；<li>通信时延较短|
|存储转发|交换机读取数据帧的所有内容之后再进行转发<li>能够识别残帧和`CRC`校验错误帧，并及时丢弃；<li>设备可以对所有数据帧进行缓存操作，连接不同速率的以太网；<li>通信时延最长|


**<font size =4 color = red>自适应交换</font>**

> 自适应交换：根据用户设置，当残帧和`CRC`错误帧的数量超过一定阈值，能够自动变更为其他传输方式的方式，叫做自适应交换。

## 2.3、半双工和全双工

|通信种类|说明|
|-|-|
|单工通信|类似于电视、广播等信号传输，固定发送方和接收方|
|半双工通信|类似于无线对讲机，一方讲话时，另外一方不能讲话|
|全双工通信|类似于电话的通信方式，一方讲话时，另外一方也可以讲话|


## 2.4、交换机的分类

|交换机分类|说明|
|-|-|
|`L2交换机`|没有`IP`路由功能和仅处理数据链路层的交换机|
|`L3交换机`|带有`IP`路由功能的交换机|

|`L2`交换机分类|说明|
|-|-|
|智能交换机|拥有`VLAN`，`QoS`，认证等功能的交换机|
|`Web`智能交换机|带有`Web`管理界面，能够通过`Web`浏览器进行访问并设置管理的智能交换机|
|智慧型交换机|具有`SNMP`功能，能够远程管理的交换机|

## 2.5、交换机性能指标的端口种类与数量

**<font size =4 color = red>快速以太网（10/100）端口</font>**

**<font size =4 color = red>千兆以太网（10/100/1000）端口</font>**

**<font size =4 color = red>光纤专用端口（`SFP/SFP+`）</font>**

**<font size =4 color = red>`PoE端口`</font>**

**<font size =4 color = red>上行链路端口数</font>**

汇聚所有下行连接的主机流量，并将这些流量传输到上行的核心交换机或网关之中，这个向核心交换机、网关传输流量的链路端口就叫做上行链路端口。反之叫做下行链路端口。

**<font size =4 color = red>下行链路端口数</font>**

## 2.6、交换机搭载的其他功能

**<font size =4 color = red>`MAC地址数`</font>**

> `MAC地址数`：指一台交换机能够学习到的`MAC地址`表的实体总数。

**<font size =4 color = red>巨型帧</font>**

通过设置可以支持巨型帧尺寸大小上限。


**<font size =4 color = red>桥接环和生成树</font>**

> 桥接环与广播风暴：假设在两个不同的网段之间，有两个交换机，这两个交换机不知道彼此的存在，会将一个网段的以太网数据帧在两台交换机中永远相互转发的状态称为桥接环。当大量的广播数据帧在桥接环内持续流通，会使整个链路的带宽被大量广播数据帧占用（广播风暴），导致普通的单播数据无法在网络中进行传输。

> 生成树:在交换机之间交换`BPDU`数据帧，使得交换机之间能够相互知道对方的存在。

由实现生成树协议的交换机所构成的，可能会发生桥接环的网络结构称为`STP`拓扑。

`STP`拓扑中，交换机分为：
1. 根网桥：`BID`（由优先级值和`MAC地址`构成）最小的，若优先级值相同，则选择`MAC地址`最小的交换机充当根网桥。每隔2s发送一次`BPDU`数据帧
2. 非根网桥：除了根网桥之外的装置。


根网桥作为发送源，每隔2s将自身`MAC地址`和多播的`MAC地址`通过`BPUD`数据帧发送到`STP`拓扑内的所有交换机中，若在20s内，没有收到`BPUD`数据帧，则网络判断`STP`拓扑发生了故障，重新计算生成树的信息。


|生成树的端口类型|说明|
|-|-|
|根端口(`RP`)|交换机所有端口中距离根网桥最近的端口。这个距离不是通过跳数来决定的，而是通过通信成本（端口的连接速度）来决定，一台非根网桥只能有一个根端口|
|指派端口(`DP`)|每个网段（冲突域）上指派一个端口，是离根网桥最近的网段上的端口。根网桥上的所有端口均是指派端口|
|非指派端口(`NDP`)|阻塞数据帧的端口，也称阻塞端口，将既不是`DP`和`RP`的指定为`NDP`|



生成树中，各个端口的迁移状态：
|状态|说明|发送数据帧|学习`MAC地址`|默认时间|
|-|-|-|-|-|
|阻塞状态|交换机各个端口进入20s的阻塞状态，该期间只能接收`BPUD`数据帧，不能发送和接收其他数据帧|不发送|不学习|20s|
|侦听状态|能够发送或者接收`BDUP`数据帧，但是不能发送或者接收其他数据帧的状态。是根端口向指派端口转发状态迁移的中间状态|不发送|不学习|15s|
|学习状态|能够发送或者接收`BDUP`数据帧、接收其他数据帧的状态。从接收到的其他数据帧中学习`MAC地址`信息。也是根端口向指派端口转发状态迁移的中间状态|不发送|学习|15s|
|转发状态|可以发送或者接收其他数据帧|发送|学习||
|禁用状态|生成树功能无效时的端口状态|发送|学习||

当交换机启动后，或者因为故障等原因导致网络拓扑变化需要重新计算生成树时，将会有50s的时间数据无法进行通信。也出现了更加高速的生成树收敛技术。


`RSTP`端口状态的收敛只需要1s。

`RSTP`将`STP`中的非指派端口分成了替换端口和备份端口。
- 替换端口：除了根端口以外连接网桥成本最低的端口，用于提供连接根网桥的备用路径，一般处于阻塞状态
- 备份端口：指派端口所连接的网段中同时连有另外一个端口，这个端口可以作为指派端口的备份，一般也处于阻塞状态。

|`STP`端口状态|`RSTP`端口状态|说明|
|-|-|-|
|禁用状态|丢弃状态|丢弃数据帧，不学习`MAC地址`|
|阻塞状态|丢弃状态|丢弃数据帧，不学习`MAC地址`|
|侦听状态|丢弃状态|丢弃数据帧，不学习`MAC地址`|
|学习状态|学习状态|丢弃流入端口的数据帧，但是学习`MAC地址`|
|转发状态|转发状态|根据流入端口的数据帧以及学习的`MAC地址`信息进行转发|


在`RSTP`中，所有的网桥均会产生`BPDU`数据帧，并同相邻交换机进行握手，获取`BDUP`数据帧的优先级信息并比较，选择根网桥和根端口。再由根端口发送`BDUP`数据帧，交换机握手才算完成。随后，对方只要在3个2s之内没有发送`BPUD`数据帧时，网络就会判断该链路失效。`RSTP`中，只需要6s即可检测出数据链路发生故障。

`RSTP`可以向下兼容`STP`，使用`RSTP`的交换机和`STP`的交换机可以在同一个网络拓扑中共存，但是这是`RSTP`无法高速收敛。


**<font size =4 color = red>链路聚合</font>**

使用链路聚合可以将多条交换机物理线路（端口）汇聚成单条逻辑线路在网络中使用。即使有其中任意一条物理线路断开，由于逻辑线路还在维持，通信也不会发生中断。

**<font size =4 color = red>`VLAN`</font>**


将广播域分隔成一个个逻辑网段的功能，称为`VLAN`


**<font size =4 color = red>端口镜像</font>**

> 端口镜像：将某个端口收发到的以太网数据帧复制到镜像端口上进行发送的功能叫做端口镜像。被复制的源端口称为监控端口。


**<font size =4 color = red>`QoS`优先级队列</font>**

当数据通过网络硬件时，根据其通信种类控制通信质量优先级和带宽的功能，一般将主干通信业务、声音、影像等数据的通信定义为优先级较高，以便得到优先处理。同时这类业务通信的时延和抖动降至最低。通过数据帧中的某几个bit位实现。

**<font size =4 color = red>`MAC地址`过滤</font>**

> 通信过滤：只让网络完成指定条件的通信过程称为通信过滤。

可以通过以太网帧首部信息进行通信过滤的功能，如设置目的`MAC地址`，发送`MAC地址`，类型域信息等。在通信时只让满足条件的数据帧通过，阻挡其他不满足条件的数据帧。


公司网络可以通过`MAC地址`过滤功能，只允许公司范围内的计算机访问公司的`LAN`，此外，考虑到还有伪造`MAC地址`的情况发生，所以需要将`MAC地址`过滤和更加严格的`LAN`接入控制认证协议一同使用。


### 基于端口的认证

> 在支持基于端口认证的交换机中，通过认证的客户端才允许被使用交换机的端口。

`IEEE 802.1X`标准提供了对接入`LAN`的客户端进行认证的一系列机制。


该认证协议常用于客户端在接入无线`LAN`接入点时的认证工作，同样也可以实现接入有线`LAN`的认证工作。

在有线`LAN`中，认证过程开始启动，根据发送方的`MAC地址`进行客户端识别，通过用户名、口令或证书等认证信息进行用户认证。对于没有认证的客户端发来的数据帧，交换机只保存包含了认证所需信息的数据帧，其余全部丢弃。而对于认证是被的客户端发来的数据帧，交换机会直接丢弃不会转发到其他端口上。

|`IEEE 802.1X`认证要素|说明|
|-|-|
|认证请求者|客户端所属的个人计算机上安装的用于`IEEE 802.1X`认证的功能实体（软件）|
|认证方|在`IEEE 802.1X`中对应的交换机或者无线`LAN`访问接口。在认证请求方和认证服务器之间转播认证消息|
|认证服务器|对认证请求方进行认证的服务器，通常使用`RADIUS`服务器|


若想要进行基于端口的认证，客户端所属的电脑与交换机双方都必须预先设置成支持使用`IEEE802.1X`进行认证。


`IEEE802.1X`认证中使用了`PPP`的扩展协议`EAP`，通过`EAPOL`协议封装`EAP`认证消息，然后在`LAN`中进行传递。认证结束之前，客户端所属的计算机无法进行`EAPOL`以外的通信。



### 网络管理

使用`SNMP`协议可以从远处对整个网络组织结构内安装的交换机和其他网络硬件进行集中统一的管理。管理网络的设施称为`管理者`，被管理的网络设备称为`代理者`。支持`SNMP`的交换机成为智慧交换机。


`SNMP`协议分为版本1，版本2，版本3，采用`UDP`的161端口进行通信，由于`TCP`需要建立连接才能完成通信，所以不适用于紧急数据通信。`UDP`无需建立连接。`SNMP`陷阱消息使用`UDP`的162端口进行数据的通信。


> `SNMP`陷阱消息：通信设备电源坏了或者`CPU`使用率超过90%，这样即使管理者没有要求，代理者也会自动发送的告警信息。

`SNMP`管理者和`SNMP`代理者之间使用的`SNMP`交互信息，包含了`SNMP`版本、`community`名称、`PDU`等信息。`PDU`是`SNMP`的指令数据。

|`PDU`|说明|
|-|-|
|`Get-Request`|`SNMP管理者`为了获取数据向`SNMP代理者`发出的请求信息。使用`UDP`的161端口发送到`SNMP代理者`，目的端口取适当的值|
|`Get-Response`|`SNMP代理者`接收到`Get-Request`消息后，返回给管理者的应答信息。代理者使用`UDP`的161端口作为发送源端口，而目的端口号是`Get-Request`消息中携带的发送源端口号|
|`Get-Next-Request`|`SNMP管理者`收到的`Get-Response`消息并获取`MIB`信息后，想要得到下一项目信息时向`SNMP代理者`发送的请求信息。代理者同样使用`Get-Response`消息作为应答。|
|`Set-Request`|想要更改通信设备的设置时，`SNMP管理者`会向`SNMP代理者`发送`Set-Request`消息，使用`UDP`的161端口作为目的端口号，代理者使用`Get-Response`消息应答|
|`Trap`|`SNMP管理者`从`SNMP代理者`自动收到的紧急信息，使用`UDP`的162端口号|

> `SNMP团体`（`commmunity`）：只有携带同样团体名称的`SNMP代理者`和`SNMP管理者`之间才可以进行`SNMP`信令交互。

### 团体（`community`）
`community`分为：
- 读取用（`Read-Only`）在`Get-Request`消息中使用
- 读写用（`Read-Write`）在`Set-Request`消息中使用
- `Trap`用

在`SNMPv3`中不再使用`community`而是使用以用户为单位的口令认证。


### MIB

网络硬件中有很多类型的配置参数来对设备进行管理，在`SNMP`中这类信息通过`MIB`这个数据库进行管理，`MIB`采用树形结构。一个通信设备一般会用到几十个`MIB`文件，总体分为`RFC`定义的标准`MIB`和各个厂商自定义的私有`MIB`两类。

`MIB`中管理的信息称为`托管对象`，其中包含了接口的`IP地址`、路由协议的设置情况等信息。

私有`MIB`一般会将各类别的`MIB`信息导入到扩展名为`.my`的纯文本文件中，然后公布在制造厂商的`Web`站点上，一般会归档为一个压缩包文件。通过下载对应的私有`MIB`文件并将其注册到`SNMP管理者`，即可使用该`SNMP`文件中提到托管对象来管理网络硬件。


### OID

`MIB`是所有托管对象的集合，而托管对象使用`OID`进行区分。`OID`采用数字加点的形式来进行描述，如`1.3.6.1.2.1.1`，在命令行中，即可通过如下命令获取到对应的`MIB`值

    > snmp get 1.3.6.1.2.1.1 

### SNMP管理者

有很多`SNMP管理者`软件，下载之后，只需要输入`SNMP代理者`的`IP`等设置信息，并将私有`MIB`信息注册到管理者软件，此外，还可以使用团体名将需要管理的代理者信息设置在管理者软件中。即可以进行操作了。

### RMON

`SNMP`中带有名为`RMON`（远程网络监控）的扩展功能。

`SNMP代理者`记录`LAN`上的通信流量信息，并保存到`RMON MIB`数据库中，当`SNMP管理者`请求这类信息时，`SNMP代理者`会在应答中返回该类信息，从而实现远程网络监控的功能。


`RMON`原先用于监控网络流量，用于安全方面的网络监控越来越多，在网络审计记录中记录访问者，什么时候访问了什么站点，如果连接了认证服务器，还可以记录用户`ID`。


### NetFlow、sFlow

在利用`RMON`监测网络流量时，如果流量超过100Mbit/s，就会需要占用大量的`CPU`或内存资源，不仅无法实现内容全部监控，而且获取大量数据会耗时过长导致数据无法实时解析。想要实时获取所需要统计的信息，就需要用到`NetFlow`和`sFlow`技术。


**<font size =4 color = red>`NetFlow`</font>**

通过`LAN`设备的分组进行识别，将与发送源`IP地址`，发送目的`IP地址`，发送源端口，发送目的端口，IP协议号，输入接口，`IP`的`ToS`值这7个参数相一致的单向传送的分组集合定义成为数据流，并对该数据流进行统计，随后将统计的结果发送到名为`NetFlow`收集器的监控装置中，就能以地址或者协议为单位进行信息的二次统计。

**<font size =4 color = red>`sFlow`</font>**

`sFlow`技术可以监控交换机上通过的分组，并在一定的周期内对其进行抽样，获得分组首部与监控到的分组的统计信息（如分组总数，字节总数），然后通过交换机内置的`sFlow`代理向`sFlow`收集器上报。`sFlow`收集器将得到的信息按照接收发方地址类型、协议类型等进行简单分类，能够统计不同类型的通信信息。


## 2.7、交换机架构

交换机的基本架构是由带有多个`RJ-45`接口，`PHY`、`MAC`等模块的网络接口控制器(`NIC`)和管理由各个`NIC`分配的收发帧缓存，转发表的软件组成。通过参考转发表信息，在`NIC`之间进行数据帧交互。

### 网络控制器

> 网络控制器（`NIC`）：能够将数据转化成以太网数据帧，按照标准通过接口进行数据传输。网络控制器一般由网络接口，`PHY`模块，`MAC`模块和总线接口构成。


### PHY模块

> 以太网物理层与数据链路层的`MAC子层`相关协议功能的实现一般会使用对应标准的处理芯片来完成，负责对以太网进行编码等物理层处理的模块叫做`PHY`。

`PHY`负责`L1`层的处理，分成三个子层完成`L2`层中`MAC`以下的处理。

### MAC模块

> `MAC`模块负责生成`MAC`数据帧等在数据链路层`MAC子层`中进行的工作，该模块简称为`MAC`

`MAC`模块负责`MAC`数据帧发送和接收的处理工作，拥有发送和接收缓存。


### AUI与MII

`MAC`与`PHY`之间的接口根据以太网、快速以太网、千兆以太网的不同，分别可以称为`AUI`、`MII`、`GMII`



