# 7、`HTTPS`

## 7.1、`HTTP`的缺点

`HTTP`的主要缺点：

- 使用通用明文，内容可能被窃听
- 不验证通信方的身份，可能遭遇伪装
- 无法验证报文的完整性，有可能被篡改

**<font size =4 color = red>通信明文可能被窃听</font>**

`TCP/IP`是可能被窃听的网络，使用抓包工具或者嗅探器工具就可以。

对`HTTP`进行加密，有两种对象，
- 通信加密，通过和`SSL`或者`TLS`的组合使用，加密`HTTP`的通信内容。用`SSL`建立安全通信线路之后，在这条线路上进行`HTTP`通信，这种方式被称为`HTTPS`。
- 内容的加密，即对报文进行加密，不同于第一种方式，这种方式依然有被篡改的风险。

**<font size =4 color = red>任何人都可以发起请求</font>**

`HTTP`不管是谁发来的请求都会返回响应。不确认通信方，存在以下的隐患：
1. 无法确定请求最终到达是否为按真实意图返回响应的服务器；
2. 无法确定响应最终返回是否为真实的客户端；
3. 无法确定正在通信的对方是否具备访问权限；
4. 无意义的请求也会照单全收，无法阻止海量请求下的`Dos`攻击（拒绝服务攻击）；
5. 无法判定请求来自何方。

使用`SSL`不仅提供加密处理，还提供了`证书`的手段，用于确定通信方，证书由值得信赖的第三方机构颁发，用于证明服务端和客户端是真实存在的。

**<font size =4 color = red>无法证明报文的完整性</font>**

请求或者响应在传输途中，遭遇攻击者拦截并篡改的攻击称为`中间人攻击`。如从某个`Web`上下载内容，无法确定客户端下载的文件和服务器上存放的文件是否前后一致。

常用的确认`HTTP`协议报文完整性的方法，就是`MD5`和`SHA-1`等散列值校验的方法，以及用来确认文件的数字签名方法。但是这些方法都需要客户端的用户本人亲自检查验证。而且`MD5`可能本身就被改写，这些也是用户无法意识到的。

## 7.2、`HTTP`+加密+认证+完整性保护=`HTTPS`

**<font size =4 color = red>`HTTPS`的本质</font>**

`HTTP`加上加密处理和认证以及完整性保护后即是`HTTPS`。`HTTPS`并非应用层新协议，只是`HTTP`通信接口部分用`SSL`和`TLS`代替而已。

通常`HTTP`直接和`TCP`通信，使用`SSL`时，先和`SSL`通信，再由`SSL`和`TCP`通信。`SSL`是独立于`HTTP`的协议，也可以与其他的应用层协议配合使用。

**<font size =4 color = red>相互交换密钥的公开密钥加密技术</font>**

> 共享密钥加密：加密和解密使用同一个密钥的方式，也叫做对称加密。

在对称加密中，加密时必须将密钥也发给对方，但是密钥也面临着被窃听的风险。

> 公开密钥加密：加密和解密使用不同的密钥，使用公钥进行加密，使用私钥进行解密。公钥可以被任何人获取，但是私钥不能被其他任何人获取。也叫做非对称加密。

要想使用密文和公开密钥恢复到明文是很难的，需要快速的对一个非常大的整数进行因式分解。相比于对称加密，非对称加密的处理速度更慢一些。`SSL`采用公开密钥加密技术。


结合`非对称加密`的安全性和`对称加密`的快速的特点，`HTTPS`采用`混合加密机制`，整个通信还是采用对称加密，但是对称加密的密钥采用非对称方式进行加密。 


**<font size =4 color = red>证明公开密钥正确性的证书</font>**

> 公开密钥加密也会面临一个问题，那就是需要证明公开密钥就是原本预想的那台服务器的公开密钥。

为了解决这个问题，可以使用数字证书认证机构（`CA`）颁发的公开密钥证书。


数字证书的认证机构属于客户端和服务端都可信赖的的第三方机构。

数字证书认证机构的业务流程如下：

1. 服务器首先将自己的公开密钥登录至数字证书认证机构。
2. 数字证书认证机构用自己的私有密钥向服务器的公开密钥部署数字签名并颁发`公钥证书`。数字证书认证机构的公开密钥大多数已经在浏览器发布版本时植入到了浏览器内部，无需再由服务器向客户端发送，因为这样容易被窃取。
3. 客户端在拿到服务器的`公钥证书`后，使用数字证书认证机构的公开密钥，向数字证书认证机构验证公钥证书上的数字签名，以确认服务器的公开密钥的真实性，验证通过则对发往服务器的报文进行加密。
4. 服务器用自己的私钥进行解密。


`HTTPS`中还可以使用客户端证书，以客户端证书进行客户端验证，证明服务器正在通信的对方始终是预料之内的客户端。但是客户端证书还有许多局限，
- 比如客户端证书的获取和发布；
- 客户端证书只能用来证明客户端是都存在，不能证明用户本人的真实有效性。

除了值得信赖的认证机构的证书，还有一些自认证证书，自签名证书的服务器在访问时，浏览器会显示"`无法确定连接安全性`或者`该网站的安全证书存在问题`，还有中级认证机构的服务器证书，对于这些，有些浏览器会将其作为正规的证书，有些会当做自签名证书。


**<font size =4 color = red>`HTTPS`的安全通信机制</font>**



![](https://segmentfault.com/img/bVbClUl "HTTPS通信过程")

`HTTPS`的通信过程可以分为两个阶段，第一个阶段是证书验证，第二个阶段是数据传输。


- 客户端通过发送`Client Hello`报文开始`SSL`通信。报文中包含客户端支持的`SSL`指定版本，加密组件列表(所使用的加密算法及密钥长度)
- 服务器可进行`SSL`通信时，会以`Server Hello`报文作为应答，包含`SSL`版本和加密组件。
- 服务器发送`Certificate`报文，包含公开密钥证书，颁发机构，过期时间等。
- 服务器通过`Server Hello Done`报文通知客户端，最初阶段的`SSL`握手协商部分结束。
- 客户端对证书进行验证（客户端解析服务器发过来的证书是通过`TSL`实现的。），如果证书不是可信机构颁布，或者证书中的域名和实际域名不一致，或者证书已经过期，就会向访问者提示警告，选择是否继续通信。如下图：

![](https://segmentfault.com/img/bVbClUs "浏览器安全警告")
- `SSL`第一次握手结束之后，客户端生成一个随机密码串，使用接收到的证书中的公钥对该密码串进行加密，称为`Pre-master secret`。
- 客户端继续发送`Change Cipher Spec`报文，该报文会提示服务器，在此报文之后的通信会采用`Pre-master secret`密钥进行对称加密。
- 服务端接收到`Pre-master secret`之后，使用私钥进行解密，获得后续堆成加密的密钥。
- 客户端发送`Finished`报文。该报文包含连接至今全部报文的整体校验值。这次握手能否成功，要以服务器是否能够解密该报文作为判定标准。
-  服务器同样发送`Change Cipher Spec`报文
-  服务器同样发送`Finished`报文。
-  服务器和客户端的`Finished`报文交换完毕之后，`SSL`连接就算建立完成。通信受到`SSL`的保护。客户端发送`HTTP`请求。
-  服务端发送HTTP响应。
-  客户端断开连接。


[HTTPS过程参考链接](https://segmentfault.com/a/1190000021494676)


`Pre-master secre`就是最终客户端和服务端通信时加密解密的密钥，属于对称加密，而这个密钥是有客户端使用公钥加密，服务端使用私钥解密这一非对称加密的手段进行加密的。


**<font size =4 color = red>`HTTPS`的不足</font>**

1. `HTTPS`在使用`SSL`时，处理速度会变慢，会消耗`CPU`和内存等硬件资源。`SSL`的慢包括通信慢，还包括消耗大量的`CPU`及内存资源，导致处理速度变慢。`HTTPS`比`HTTP`慢2-100倍。
2. 购买证书需要成本。
3. `HTTPS`的安全是有范围的，在黑客攻击，服务器劫持的情况下，几乎起不到作用。
